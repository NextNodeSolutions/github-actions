# NextNode Default Configuration for Dokploy Deployments
# Projects only need to override what differs from these defaults

# =============================================================================
# CLUSTER CONFIGURATION (Docker Swarm)
# =============================================================================
[cluster]
# Traefik ingress server - all DNS records point here
# In Swarm mode, Traefik routes traffic to services on worker nodes
traefik-server = "admin-dokploy"

# =============================================================================
# BUILD CONFIGURATION
# =============================================================================
[build]
type = "dockerfile"           # dockerfile | nixpacks | buildpacks | static
dockerfile = "Dockerfile"
context = "."
target = ""                   # Multi-stage build target (optional)

# =============================================================================
# RESOURCE DEFAULTS
# =============================================================================
[resources]
memory = "512Mi"
cpu = 0.5
memory_limit = "1Gi"          # Hard limit
cpu_limit = 1                 # Hard limit

# =============================================================================
# HEALTH CHECK DEFAULTS
# =============================================================================
[healthcheck]
enabled = true
path = "/health"
# port defaults to detected APP_PORT from Dockerfile/.env
# only set explicitly if healthcheck runs on a different port than app
interval = 30                 # seconds between checks
timeout = 10                  # seconds before check times out
retries = 3                   # failures before unhealthy
start_period = 40             # seconds grace period on startup
rollback = true               # auto-rollback to previous version on failure
update_delay = 10             # seconds between container updates

# =============================================================================
# DEPLOYMENT DEFAULTS
# =============================================================================
[deploy]
restart_policy = "unless-stopped"
rollback_on_failure = true

# =============================================================================
# COMPOSE DEPLOYMENT MODE
# =============================================================================
# Deploy using docker-compose.yml instead of building a Docker image
# When enabled, the [build] section is ignored
[compose]
enabled = false
# file defaults to "docker-compose.yml" in code when enabled = true

# =============================================================================
# VPS DEFAULTS (for custom dedicated servers)
# =============================================================================
[vps]
enabled = false

# =============================================================================
# SERVICES DEFAULTS (future - not yet implemented)
# =============================================================================
[services.postgres]
enabled = false
version = "16"
size = "small"                # small (1GB), medium (4GB), large (8GB)

[services.redis]
enabled = false
version = "7"
size = "small"

[services.minio]
enabled = false
bucket = "uploads"

[services.infisical]
enabled = false

# =============================================================================
# SCALE-TO-ZERO (Sablier)
# Automatically scales idle dev/preview containers to 0 replicas
# Wakes them on-demand when requests arrive (shows loading page while starting)
# =============================================================================
[scale_to_zero]
enabled = true                    # Enable for dev/preview by default
idle_timeout = "30m"              # Scale to 0 after 30 minutes of inactivity
session_duration = "30m"          # Keep alive for 30 minutes after wake
startup_timeout = "2m"            # Max time to wait for service to start
theme = "hacker-terminal"         # Loading page theme: hacker-terminal, ghost, shuffle

# =============================================================================
# ENVIRONMENT: DEVELOPMENT
# Domain: dev.{project.domain}
# =============================================================================
[environments.development]
enabled = true
server = "dev-worker"
replicas = 1
# Lighter resources for dev (only you use it)
memory = "128Mi"
cpu = 0.1
memory_limit = "256Mi"
cpu_limit = 0.25
# Scale-to-zero enabled by default for dev
scale_to_zero = true

# =============================================================================
# ENVIRONMENT: PREVIEW (PR deployments)
# Domain: pr-{number}.{project.domain}
# Requires project.domain to be set
# =============================================================================
[environments.preview]
enabled = true
server = "dev-worker"
replicas = 1
cleanup_on_merge = true
# Lighter resources for PR previews
memory = "128Mi"
cpu = 0.1
memory_limit = "256Mi"
cpu_limit = 0.25
# Scale-to-zero enabled by default for preview
scale_to_zero = true

# =============================================================================
# ENVIRONMENT: PRODUCTION
# Domain: {project.domain}
# =============================================================================
[environments.production]
server = "prod-worker"
replicas = 1
