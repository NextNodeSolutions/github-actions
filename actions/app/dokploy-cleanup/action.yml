name: 'Dokploy Cleanup'
description: 'Cleanup preview deployments (application or compose)'
author: 'NextNodeSolutions'

inputs:
  dokploy-url:
    description: 'Dokploy instance URL'
    required: true
  dokploy-token:
    description: 'Dokploy bearer token'
    required: true
  project-name:
    description: 'Project name'
    required: true
  pr-number:
    description: 'PR number to cleanup'
    required: true
  is-compose:
    description: 'Whether this is a compose deployment'
    required: false
    default: 'false'

outputs:
  deleted:
    description: 'Whether a resource was deleted'
    value: ${{ steps.cleanup.outputs.deleted }}
  resource-type:
    description: 'Type of resource deleted (application or compose)'
    value: ${{ steps.cleanup.outputs.resource-type }}
  success:
    description: 'Whether cleanup succeeded'
    value: ${{ steps.cleanup.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: nextnodesolutions/github-actions/actions/utilities/python-setup@main
      with:
        packages: 'requests'

    - name: Cleanup preview
      id: cleanup
      shell: python
      env:
        DOKPLOY_URL: ${{ inputs.dokploy-url }}
        DOKPLOY_TOKEN: ${{ inputs.dokploy-token }}
        PROJECT_NAME: ${{ inputs.project-name }}
        PR_NUMBER: ${{ inputs.pr-number }}
        IS_COMPOSE: ${{ inputs.is-compose }}
      run: |
        import os
        import sys

        from lib.dokploy import DokployClient, DokployError, Endpoints, output

        PROJECT_NAME = os.environ['PROJECT_NAME']
        PR_NUMBER = os.environ['PR_NUMBER']
        IS_COMPOSE = os.environ.get('IS_COMPOSE', 'false') == 'true'

        preview_name = f"{PROJECT_NAME}-pr-{PR_NUMBER}"

        print("::group::Cleanup preview deployment")
        print(f"Looking for: {preview_name}")

        try:
            client = DokployClient.from_env()

            # Get all projects
            projects = client.get(Endpoints.PROJECT_ALL, raise_for_status=False)
            if not isinstance(projects, list):
                projects = []

            # Find project
            project_id = None
            for p in projects:
                if p.get('name') == PROJECT_NAME:
                    project_id = p.get('projectId')
                    break

            if not project_id:
                print(f"Project {PROJECT_NAME} not found")
                output('deleted', 'false')
                output('resource-type', '')
                output('success', 'true')
                print("::endgroup::")
                sys.exit(0)

            # Get project details
            proj_data = client.get(
                Endpoints.PROJECT_ONE,
                params={"projectId": project_id},
                raise_for_status=False
            )

            if not isinstance(proj_data, dict):
                print("Failed to get project details")
                output('deleted', 'false')
                output('success', 'true')
                print("::endgroup::")
                sys.exit(0)

            deleted = False
            resource_type = ''

            if IS_COMPOSE:
                # Look for compose stacks
                composes = proj_data.get('compose', [])
                for env in proj_data.get('environments', []):
                    composes.extend(env.get('compose', []))

                for compose in composes:
                    if compose.get('name') == preview_name:
                        try:
                            client.post(
                                Endpoints.COMPOSE_DELETE,
                                json={"composeId": compose.get('composeId')}
                            )
                            print(f"Deleted compose: {preview_name}")
                            deleted = True
                            resource_type = 'compose'
                        except DokployError as e:
                            print(f"::warning::Failed to delete compose: {e}")
                        break
            else:
                # Look for applications
                apps = proj_data.get('applications', [])
                for env in proj_data.get('environments', []):
                    apps.extend(env.get('applications', []))

                for app in apps:
                    if app.get('name') == preview_name:
                        try:
                            client.post(
                                Endpoints.APPLICATION_DELETE,
                                json={"applicationId": app.get('applicationId')}
                            )
                            print(f"Deleted application: {preview_name}")
                            deleted = True
                            resource_type = 'application'
                        except DokployError as e:
                            print(f"::warning::Failed to delete application: {e}")
                        break

            if not deleted:
                print(f"No preview resource found for: {preview_name}")

            output('deleted', 'true' if deleted else 'false')
            output('resource-type', resource_type)
            output('success', 'true')

        except DokployError as e:
            print(f"::warning::Cleanup failed: {e}")
            output('deleted', 'false')
            output('resource-type', '')
            output('success', 'true')  # Don't fail the workflow on cleanup errors

        print("::endgroup::")
