name: 'Cloudflare DNS Cleanup'
description: 'Clean up DNS records from Cloudflare for PR previews'
author: 'NextNodeSolutions'

inputs:
  domain:
    description: 'Domain to clean up (e.g., pr-56.dev.nextnode.fr)'
    required: true
  cloudflare-api-token:
    description: 'Cloudflare API token'
    required: true
  cloudflare-zone-id:
    description: 'Cloudflare Zone ID (optional, will be auto-detected)'
    required: false

outputs:
  records-deleted:
    description: 'Number of DNS records deleted'
    value: ${{ steps.cleanup.outputs.records-deleted }}
  success:
    description: 'Whether cleanup was successful'
    value: ${{ steps.cleanup.outputs.success }}

runs:
  using: 'composite'
  steps:
    # Use the shared zone lookup utility if zone-id not provided
    - name: Lookup Cloudflare Zone
      id: zone-lookup
      if: ${{ inputs.cloudflare-zone-id == '' }}
      uses: nextnodesolutions/github-actions/actions/utilities/cloudflare-zone-lookup@main
      with:
        domain: ${{ inputs.domain }}
        cloudflare-api-token: ${{ inputs.cloudflare-api-token }}
      continue-on-error: true

    - name: Cleanup Cloudflare DNS Records
      id: cleanup
      shell: bash
      env:
        CF_API_TOKEN: ${{ inputs.cloudflare-api-token }}
        CF_ZONE_ID: ${{ inputs.cloudflare-zone-id || steps.zone-lookup.outputs.zone-id }}
        INPUT_DOMAIN: ${{ inputs.domain }}
      run: |
        echo "::group::ðŸ§¹ Cleaning up Cloudflare DNS records"

        DOMAIN="$INPUT_DOMAIN"
        RECORDS_DELETED=0

        echo "â€¢ Target domain: $DOMAIN"

        # Verify zone ID is available
        if [[ -z "$CF_ZONE_ID" || "$CF_ZONE_ID" == "null" ]]; then
          echo "âŒ Could not determine Zone ID (provide cloudflare-zone-id or ensure domain lookup succeeded)"
          echo "records-deleted=0" >> $GITHUB_OUTPUT
          echo "success=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 0
        fi

        echo "â€¢ Zone ID: ${CF_ZONE_ID:0:8}..."

        # List of records to delete
        RECORDS_TO_DELETE=(
          "$DOMAIN"
          "_acme-challenge.$DOMAIN"
          "www.$DOMAIN"
        )

        echo ""
        echo "ðŸ“‹ Records to delete:"
        for record in "${RECORDS_TO_DELETE[@]}"; do
          echo "  â€¢ $record"
        done
        echo ""

        # Delete each record
        for RECORD_NAME in "${RECORDS_TO_DELETE[@]}"; do
          echo "ðŸ” Searching for: $RECORD_NAME"

          # Get all DNS records matching this name
          RECORDS=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records?name=$RECORD_NAME" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json")

          RECORD_IDS=$(echo "$RECORDS" | jq -r '.result[].id // empty')

          if [[ -z "$RECORD_IDS" ]]; then
            echo "  â„¹ï¸  No record found (already deleted or never created)"
            continue
          fi

          # Delete each matching record ID
          echo "$RECORD_IDS" | while read -r RECORD_ID; do
            if [[ -n "$RECORD_ID" && "$RECORD_ID" != "null" ]]; then
              echo "  ðŸ—‘ï¸  Deleting record ID: ${RECORD_ID:0:8}..."

              DELETE_RESPONSE=$(curl -s -X DELETE "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records/$RECORD_ID" \
                -H "Authorization: Bearer $CF_API_TOKEN" \
                -H "Content-Type: application/json")

              SUCCESS=$(echo "$DELETE_RESPONSE" | jq -r '.success // false')

              if [[ "$SUCCESS" == "true" ]]; then
                echo "  âœ… Deleted successfully"
                RECORDS_DELETED=$((RECORDS_DELETED + 1))
              else
                echo "  âš ï¸  Deletion failed:"
                echo "$DELETE_RESPONSE" | jq '.errors' 2>/dev/null || echo "$DELETE_RESPONSE"
              fi
            fi
          done
        done

        echo ""
        echo "ðŸ“Š Cleanup Summary:"
        echo "  â€¢ Records deleted: $RECORDS_DELETED"

        # Set outputs
        echo "records-deleted=$RECORDS_DELETED" >> $GITHUB_OUTPUT
        echo "success=true" >> $GITHUB_OUTPUT

        echo "::endgroup::"
