name: 'VPS Provision'
description: 'Provision and register a custom VPS for Dokploy deployments. Composes atomic actions: vps-status-check, vps-terraform-apply, vps-tailscale-wait, vps-dokploy-register'
author: 'NextNodeSolutions'

inputs:
  vps-name:
    description: 'Name of the VPS to provision'
    required: true
  project-name:
    description: 'Project name for tagging'
    required: true
  server-type:
    description: 'Hetzner server type (e.g., cx33)'
    required: false
    default: 'cx33'
  environment:
    description: 'Environment name'
    required: false
    default: 'production'
  hetzner-token:
    description: 'Hetzner Cloud API token'
    required: true
  tailscale-auth-key:
    description: 'Tailscale auth key for VPS to join network'
    required: true
  tailscale-api-token:
    description: 'Tailscale API token for status checks'
    required: true
  cloudflare-api-token:
    description: 'Cloudflare API token (for Terraform)'
    required: true
  tf-api-token:
    description: 'Terraform Cloud API token'
    required: true
  github-token:
    description: 'GitHub token with access to infrastructure repo'
    required: true
  dokploy-url:
    description: 'Dokploy instance URL'
    required: true
  dokploy-api-token:
    description: 'Dokploy API token (from Settings > Profile > API/CLI)'
    required: true

outputs:
  provisioned:
    description: 'Whether a new VPS was provisioned'
    value: ${{ steps.set-outputs.outputs.provisioned }}
  server-ip:
    description: 'Public IP of the VPS'
    value: ${{ steps.set-outputs.outputs.server-ip }}
  tailscale-ip:
    description: 'Tailscale IP of the VPS'
    value: ${{ steps.set-outputs.outputs.tailscale-ip }}
  server-id:
    description: 'Dokploy server ID'
    value: ${{ steps.register.outputs.server-id }}
  success:
    description: 'Whether provisioning succeeded'
    value: ${{ steps.register.outputs.success }}

runs:
  using: 'composite'
  steps:
    # Step 1: Check VPS status in Hetzner and Tailscale
    - name: Check VPS Status
      id: check
      uses: nextnodesolutions/github-actions/actions/deploy/vps-status-check@main
      with:
        vps-name: ${{ inputs.vps-name }}
        hcloud-token: ${{ inputs.hetzner-token }}
        tailscale-api-key: ${{ inputs.tailscale-api-token }}

    # Step 2: Provision VPS with Terraform if needed
    - name: Provision VPS
      id: provision
      if: steps.check.outputs.needs-provision == 'true'
      uses: nextnodesolutions/github-actions/actions/deploy/vps-terraform-apply@main
      with:
        vps-name: ${{ inputs.vps-name }}
        project-name: ${{ inputs.project-name }}
        server-type: ${{ inputs.server-type }}
        hcloud-token: ${{ inputs.hetzner-token }}
        tailscale-auth-key: ${{ inputs.tailscale-auth-key }}
        cloudflare-api-token: ${{ inputs.cloudflare-api-token }}
        tf-api-token: ${{ inputs.tf-api-token }}
        github-token: ${{ inputs.github-token }}

    # Step 3: Wait for Tailscale if VPS was just provisioned or not yet in Tailscale
    - name: Wait for Tailscale
      id: wait-tailscale
      if: steps.check.outputs.needs-provision == 'true' || steps.check.outputs.needs-wait == 'true'
      uses: nextnodesolutions/github-actions/actions/deploy/vps-tailscale-wait@main
      with:
        vps-name: ${{ inputs.vps-name }}
        tailscale-api-key: ${{ inputs.tailscale-api-token }}
        timeout-seconds: '300'

    # Step 4: Consolidate outputs
    - name: Set Outputs
      id: set-outputs
      shell: bash
      env:
        PROVISIONED: ${{ steps.check.outputs.needs-provision }}
        PROVISION_IP: ${{ steps.provision.outputs.server-ip }}
        HETZNER_IP: ${{ steps.check.outputs.hetzner-ip }}
        WAIT_TAILSCALE_IP: ${{ steps.wait-tailscale.outputs.tailscale-ip }}
        EXISTING_TAILSCALE_IP: ${{ steps.check.outputs.tailscale-ip }}
      run: |
        echo "::group::Consolidate Outputs"

        # Determine server IP
        if [[ -n "$PROVISION_IP" ]]; then
          echo "server-ip=$PROVISION_IP" >> $GITHUB_OUTPUT
        else
          echo "server-ip=$HETZNER_IP" >> $GITHUB_OUTPUT
        fi

        # Determine Tailscale IP
        if [[ -n "$WAIT_TAILSCALE_IP" ]]; then
          TAILSCALE_IP="$WAIT_TAILSCALE_IP"
        else
          TAILSCALE_IP="$EXISTING_TAILSCALE_IP"
        fi
        echo "tailscale-ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT

        # Set provisioned flag
        echo "provisioned=$PROVISIONED" >> $GITHUB_OUTPUT

        echo "::endgroup::"

    # Step 5: Register VPS in Dokploy
    - name: Register in Dokploy
      id: register
      uses: nextnodesolutions/github-actions/actions/deploy/vps-dokploy-register@main
      with:
        dokploy-url: ${{ inputs.dokploy-url }}
        dokploy-api-token: ${{ inputs.dokploy-api-token }}
        server-name: ${{ inputs.vps-name }}
        server-ip: ${{ steps.set-outputs.outputs.tailscale-ip }}
