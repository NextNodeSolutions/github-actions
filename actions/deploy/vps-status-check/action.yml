name: 'VPS Status Check'
description: 'Check if VPS exists in Hetzner and Tailscale, determine if provisioning is needed'
author: 'NextNodeSolutions'

inputs:
  vps-name:
    description: 'Name of the VPS to check'
    required: true
  hcloud-token:
    description: 'Hetzner Cloud API token'
    required: true
  tailscale-api-key:
    description: 'Tailscale API key for status checks'
    required: true
  expected-config-hash:
    description: 'Expected config hash for change detection'
    required: false
    default: ''

outputs:
  hetzner-exists:
    description: 'Whether the VPS exists in Hetzner'
    value: ${{ steps.hetzner.outputs.exists }}
  tailscale-exists:
    description: 'Whether the VPS exists in Tailscale'
    value: ${{ steps.tailscale.outputs.exists }}
  hetzner-ip:
    description: 'Hetzner public IPv4 address'
    value: ${{ steps.hetzner.outputs.ipv4-address }}
  tailscale-ip:
    description: 'Tailscale IP address'
    value: ${{ steps.tailscale.outputs.ip-address }}
  needs-provision:
    description: 'Whether VPS needs to be provisioned (not in Hetzner)'
    value: ${{ steps.decide.outputs.needs-provision }}
  needs-wait:
    description: 'Whether we need to wait for Tailscale (in Hetzner but not in Tailscale)'
    value: ${{ steps.decide.outputs.needs-wait }}
  config-mismatch:
    description: 'Whether VPS config has changed'
    value: ${{ steps.decide.outputs.config-mismatch }}
  needs-destroy:
    description: 'Whether VPS needs destruction (broken or config changed)'
    value: ${{ steps.decide.outputs.needs-destroy }}
  actual-config-hash:
    description: 'Current config hash from server labels'
    value: ${{ steps.hetzner.outputs.config-hash }}

runs:
  using: 'composite'
  steps:
    - name: Check Hetzner Status
      id: hetzner
      uses: nextnodesolutions/github-actions/actions/utilities/hetzner-server-lookup@main
      with:
        hcloud-token: ${{ inputs.hcloud-token }}
        server-name: ${{ inputs.vps-name }}

    - name: Check Tailscale Status
      id: tailscale
      uses: nextnodesolutions/github-actions/actions/utilities/tailscale-device-lookup@main
      with:
        tailscale-api-key: ${{ inputs.tailscale-api-key }}
        hostname: ${{ inputs.vps-name }}

    - name: Decide Action Needed
      id: decide
      shell: bash
      env:
        HETZNER_EXISTS: ${{ steps.hetzner.outputs.exists }}
        TAILSCALE_EXISTS: ${{ steps.tailscale.outputs.exists }}
        VPS_NAME: ${{ inputs.vps-name }}
        EXPECTED_HASH: ${{ inputs.expected-config-hash }}
        ACTUAL_HASH: ${{ steps.hetzner.outputs.config-hash }}
      run: |
        echo "::group::VPS Status Summary"
        echo "VPS: $VPS_NAME"
        echo "  Hetzner: $HETZNER_EXISTS"
        echo "  Tailscale: $TAILSCALE_EXISTS"
        echo "  Expected config hash: $EXPECTED_HASH"
        echo "  Actual config hash: $ACTUAL_HASH"

        NEEDS_PROVISION="false"
        NEEDS_WAIT="false"
        NEEDS_DESTROY="false"
        CONFIG_MISMATCH="false"

        if [[ "$HETZNER_EXISTS" == "false" ]]; then
          NEEDS_PROVISION="true"
          echo "  Action: Needs provisioning"
        elif [[ "$TAILSCALE_EXISTS" == "false" ]]; then
          # VPS exists but not in Tailscale = BROKEN STATE
          NEEDS_DESTROY="true"
          echo "  Action: VPS in broken state (not in Tailscale) - will destroy and recreate"
        elif [[ -n "$EXPECTED_HASH" && "$ACTUAL_HASH" != "$EXPECTED_HASH" ]]; then
          # Config changed
          CONFIG_MISMATCH="true"
          NEEDS_DESTROY="true"
          echo "  Action: Config mismatch ($ACTUAL_HASH != $EXPECTED_HASH) - will destroy and recreate"
        else
          echo "  Action: Ready"
        fi

        echo "needs-provision=$NEEDS_PROVISION" >> $GITHUB_OUTPUT
        echo "needs-wait=$NEEDS_WAIT" >> $GITHUB_OUTPUT
        echo "needs-destroy=$NEEDS_DESTROY" >> $GITHUB_OUTPUT
        echo "config-mismatch=$CONFIG_MISMATCH" >> $GITHUB_OUTPUT

        echo "::endgroup::"
