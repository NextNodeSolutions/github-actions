name: 'VPS Dokploy Register'
description: 'Register VPS as a Dokploy server'
author: 'NextNodeSolutions'

inputs:
  dokploy-url:
    description: 'Dokploy instance URL'
    required: true
  dokploy-api-token:
    description: 'Dokploy API token (from Settings > Profile > API/CLI)'
    required: true
  server-name:
    description: 'Name for the server in Dokploy'
    required: true
  server-ip:
    description: 'IP address of the server (Tailscale IP recommended)'
    required: true
  ssh-key-id:
    description: 'Dokploy SSH key ID (optional, will auto-detect if not provided)'
    required: false
    default: ''
  ssh-key-name:
    description: 'SSH key name to look for if ssh-key-id not provided'
    required: false
    default: 'nextnode-dokploy-ci'

outputs:
  server-id:
    description: 'Dokploy server ID'
    value: ${{ steps.register.outputs.server-id }}
  registered:
    description: 'Whether server was newly registered (vs already existed)'
    value: ${{ steps.register.outputs.registered }}
  ip-updated:
    description: 'Whether server IP was updated (existing server had different IP)'
    value: ${{ steps.register.outputs.ip-updated }}
  success:
    description: 'Whether registration succeeded'
    value: ${{ steps.register.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: nextnodesolutions/github-actions/actions/utilities/python-setup@main
      with:
        packages: 'requests'

    - name: Register in Dokploy
      id: register
      shell: python
      env:
        DOKPLOY_URL: ${{ inputs.dokploy-url }}
        DOKPLOY_TOKEN: ${{ inputs.dokploy-api-token }}
        SERVER_NAME: ${{ inputs.server-name }}
        SERVER_IP: ${{ inputs.server-ip }}
        SSH_KEY_ID: ${{ inputs.ssh-key-id }}
        SSH_KEY_NAME: ${{ inputs.ssh-key-name }}
      run: |
        import os
        import sys
        import time

        from lib.dokploy import DokployAuthError, DokployClient, DokployError, output

        SERVER_NAME = os.environ['SERVER_NAME']
        SERVER_IP = os.environ['SERVER_IP']
        SSH_KEY_ID = os.environ.get('SSH_KEY_ID', '')
        SSH_KEY_NAME = os.environ.get('SSH_KEY_NAME', 'nextnode-dokploy-ci')

        print("::group::Dokploy Registration")

        try:
            client = DokployClient.from_env()

            # Check if server already exists
            print(f"Checking if server '{SERVER_NAME}' exists...")
            existing = client.get_server_by_name(SERVER_NAME)

            if existing:
                server_id = existing.get('serverId')
                existing_ip = existing.get('ipAddress')

                if existing_ip != SERVER_IP:
                    print(f"Server IP changed: {existing_ip} -> {SERVER_IP}")
                    print(f"Updating server {server_id}...")
                    client.update_server(server_id, ip_address=SERVER_IP)
                    print("Server IP updated successfully")
                    output('server-id', server_id)
                    output('registered', 'false')
                    output('ip-updated', 'true')
                    output('success', 'true')
                else:
                    print(f"Server already registered with correct IP: {server_id}")
                    output('server-id', server_id)
                    output('registered', 'false')
                    output('ip-updated', 'false')
                    output('success', 'true')

                print("::endgroup::")
                sys.exit(0)

            # Get SSH key ID if not provided
            if not SSH_KEY_ID:
                print(f"Looking for SSH key '{SSH_KEY_NAME}'...")
                ssh_key = client.get_ssh_key_by_name(SSH_KEY_NAME)

                if ssh_key:
                    SSH_KEY_ID = ssh_key.get('sshKeyId')
                    print(f"Found SSH key: {SSH_KEY_ID}")
                else:
                    # Use first available key
                    keys = client.list_ssh_keys()
                    if keys:
                        SSH_KEY_ID = keys[0].get('sshKeyId')
                        print(f"Using first available SSH key: {SSH_KEY_ID}")

            if not SSH_KEY_ID:
                print("::error::No SSH key found in Dokploy. Run dokploy-init-workers first.")
                output('success', 'false')
                print("::endgroup::")
                sys.exit(1)

            # Create server
            print(f"Registering server: {SERVER_NAME} ({SERVER_IP})")
            result = client.create_server(
                name=SERVER_NAME,
                ip_address=SERVER_IP,
                ssh_key_id=SSH_KEY_ID,
            )

            server_id = result.get('serverId')

            # If no serverId in response, query again
            if not server_id:
                print("Waiting for server to be created...")
                time.sleep(2)
                created = client.get_server_by_name(SERVER_NAME)
                if created:
                    server_id = created.get('serverId')

            if not server_id:
                print("::error::Failed to register server - no serverId returned")
                output('success', 'false')
                print("::endgroup::")
                sys.exit(1)

            print(f"Server registered: {server_id}")

            # Setup server (Docker + Swarm)
            print("Setting up server (Docker + Swarm)...")
            try:
                client.setup_server(server_id)
                print("Server setup initiated")
            except DokployError as e:
                # Setup may take time, don't fail on timeout
                print(f"Setup request sent (may complete asynchronously): {e}")

            output('server-id', server_id)
            output('registered', 'true')
            output('success', 'true')

        except DokployAuthError as e:
            print("::error::Invalid API token")
            output('success', 'false')
            sys.exit(1)

        except DokployError as e:
            print(f"::error::Dokploy API error: {e}")
            output('success', 'false')
            sys.exit(1)

        print("::endgroup::")
