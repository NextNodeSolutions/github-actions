name: 'VPS Dokploy Register'
description: 'Register VPS as a Dokploy server'
author: 'NextNodeSolutions'

inputs:
  dokploy-url:
    description: 'Dokploy instance URL'
    required: true
  dokploy-admin-email:
    description: 'Dokploy admin email'
    required: true
  dokploy-admin-password:
    description: 'Dokploy admin password'
    required: true
  server-name:
    description: 'Name for the server in Dokploy'
    required: true
  server-ip:
    description: 'IP address of the server (Tailscale IP recommended)'
    required: true
  ssh-key-id:
    description: 'Dokploy SSH key ID (optional, will auto-detect if not provided)'
    required: false
    default: ''
  ssh-key-name:
    description: 'SSH key name to look for if ssh-key-id not provided'
    required: false
    default: 'nextnode-dokploy-ci'

outputs:
  server-id:
    description: 'Dokploy server ID'
    value: ${{ steps.register.outputs.server-id }}
  registered:
    description: 'Whether server was newly registered (vs already existed)'
    value: ${{ steps.register.outputs.registered }}
  success:
    description: 'Whether registration succeeded'
    value: ${{ steps.register.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Register in Dokploy
      id: register
      shell: bash
      env:
        DOKPLOY_URL: ${{ inputs.dokploy-url }}
        DOKPLOY_ADMIN_EMAIL: ${{ inputs.dokploy-admin-email }}
        DOKPLOY_ADMIN_PASSWORD: ${{ inputs.dokploy-admin-password }}
        SERVER_NAME: ${{ inputs.server-name }}
        SERVER_IP: ${{ inputs.server-ip }}
        SSH_KEY_ID: ${{ inputs.ssh-key-id }}
        SSH_KEY_NAME: ${{ inputs.ssh-key-name }}
      run: |
        echo "::group::Dokploy Registration"

        # Authenticate with Dokploy (Better-Auth session cookies)
        COOKIE_JAR="/tmp/dokploy_cookies_$$.txt"

        echo "Authenticating with Dokploy..."
        AUTH_RESPONSE=$(curl -s -c "$COOKIE_JAR" -X POST "${DOKPLOY_URL}/api/auth/sign-in/email" \
          -H "Content-Type: application/json" \
          -d "$(jq -n --arg e "$DOKPLOY_ADMIN_EMAIL" --arg p "$DOKPLOY_ADMIN_PASSWORD" '{email:$e,password:$p}')")

        if [[ -z "$AUTH_RESPONSE" ]]; then
          echo "::error::Authentication failed - no response"
          echo "success=false" >> $GITHUB_OUTPUT
          rm -f "$COOKIE_JAR"
          exit 1
        fi

        if ! echo "$AUTH_RESPONSE" | jq -e '.token' > /dev/null 2>&1; then
          echo "::error::Authentication failed"
          echo "Auth response: $AUTH_RESPONSE"
          echo "success=false" >> $GITHUB_OUTPUT
          rm -f "$COOKIE_JAR"
          exit 1
        fi
        echo "Authentication successful"

        # Get SSH key ID if not provided
        if [[ -z "$SSH_KEY_ID" ]]; then
          echo "Getting SSH key ID..."
          EXISTING_KEYS=$(curl -s -b "$COOKIE_JAR" -X GET "${DOKPLOY_URL}/api/sshKey.all" \
            -H "Content-Type: application/json")

          # Try to find the specified key first
          SSH_KEY_ID=$(echo "$EXISTING_KEYS" | jq -r --arg name "$SSH_KEY_NAME" '.[] | select(.name == $name) | .sshKeyId' 2>/dev/null | head -1)

          if [[ -z "$SSH_KEY_ID" ]]; then
            # Use first available key
            SSH_KEY_ID=$(echo "$EXISTING_KEYS" | jq -r '.[0].sshKeyId // empty' 2>/dev/null)
          fi

          if [[ -z "$SSH_KEY_ID" ]]; then
            echo "::error::No SSH key found in Dokploy. Run dokploy-init-workers first."
            echo "success=false" >> $GITHUB_OUTPUT
            rm -f "$COOKIE_JAR"
            exit 1
          fi
        fi
        echo "Using SSH key ID: $SSH_KEY_ID"

        # Check if server exists
        echo "Checking if server exists in Dokploy..."
        EXISTING_SERVERS=$(curl -s -b "$COOKIE_JAR" -X GET "${DOKPLOY_URL}/api/server.all" \
          -H "Content-Type: application/json")

        if [[ -z "$EXISTING_SERVERS" || "$EXISTING_SERVERS" == "null" ]]; then
          EXISTING_SERVERS="[]"
        fi

        EXISTING_ID=$(echo "$EXISTING_SERVERS" | jq -r --arg name "$SERVER_NAME" '.[] | select(.name == $name) | .serverId' 2>/dev/null | head -1)

        if [[ -n "$EXISTING_ID" ]]; then
          echo "Server already registered: $EXISTING_ID"
          echo "server-id=$EXISTING_ID" >> $GITHUB_OUTPUT
          echo "registered=false" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
          rm -f "$COOKIE_JAR"
          echo "::endgroup::"
          exit 0
        fi

        # Register new server
        echo "Registering server: ${SERVER_NAME} (${SERVER_IP})"

        CREATE_DATA=$(jq -n --arg n "$SERVER_NAME" --arg ip "$SERVER_IP" --arg keyId "$SSH_KEY_ID" \
          '{name:$n,ipAddress:$ip,port:22,username:"root",sshKeyId:$keyId}')
        WRAPPED_DATA="{\"0\":{\"json\":${CREATE_DATA}}}"

        CREATE_RESPONSE=$(curl -s -b "$COOKIE_JAR" -X POST "${DOKPLOY_URL}/api/trpc/server.create?batch=1" \
          -H "Content-Type: application/json" \
          -d "$WRAPPED_DATA")

        echo "Create response: $CREATE_RESPONSE"

        # Extract serverId from tRPC batch response
        SERVER_ID=$(echo "$CREATE_RESPONSE" | jq -r '.[0].result.data.json.serverId // .[0].result.data.serverId // empty')

        if [[ -z "$SERVER_ID" ]]; then
          # Try to get ID by querying again
          sleep 2
          SERVERS_AFTER=$(curl -s -b "$COOKIE_JAR" -X GET "${DOKPLOY_URL}/api/server.all" \
            -H "Content-Type: application/json")
          SERVER_ID=$(echo "$SERVERS_AFTER" | jq -r --arg name "$SERVER_NAME" '.[] | select(.name == $name) | .serverId' 2>/dev/null | head -1)

          if [[ -z "$SERVER_ID" ]]; then
            echo "::error::Failed to register server"
            echo "success=false" >> $GITHUB_OUTPUT
            rm -f "$COOKIE_JAR"
            exit 1
          fi
        fi

        echo "Server registered: $SERVER_ID"

        # Setup server (Docker + Swarm)
        echo "Setting up server (Docker + Swarm)..."
        SETUP_DATA=$(jq -n --arg id "$SERVER_ID" '{serverId:$id}')
        WRAPPED_SETUP="{\"0\":{\"json\":${SETUP_DATA}}}"
        curl -s -b "$COOKIE_JAR" -X POST "${DOKPLOY_URL}/api/trpc/server.setup?batch=1" \
          -H "Content-Type: application/json" \
          -d "$WRAPPED_SETUP" > /dev/null 2>&1 || true

        echo "server-id=$SERVER_ID" >> $GITHUB_OUTPUT
        echo "registered=true" >> $GITHUB_OUTPUT
        echo "success=true" >> $GITHUB_OUTPUT

        rm -f "$COOKIE_JAR"
        echo "::endgroup::"
