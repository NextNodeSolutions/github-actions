name: 'Railway Project Setup'
description: 'Create or link Railway project'
author: 'NextNodeSolutions'

inputs:
  app-name:
    description: 'Application/Project name'
    required: true
  railway-token:
    description: 'Railway API token'
    required: true

outputs:
  project-id:
    description: 'Railway project ID'
    value: ${{ steps.setup.outputs.project-id }}
  project-name:
    description: 'Railway project name'
    value: ${{ steps.setup.outputs.project-name }}
  created:
    description: 'Whether project was created (true) or linked (false)'
    value: ${{ steps.setup.outputs.created }}

runs:
  using: 'composite'
  steps:
    - name: Setup Railway Project
      id: setup
      shell: bash
      run: |
        echo "::group::📦 Setting up Railway Project"
        
        START_TIME=$(date +%s)
        
        # Use app-name as project name
        PROJECT_NAME="${{ inputs.app-name }}"
        echo "• Project name: $PROJECT_NAME"
        echo "project-name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        
        # Check if project exists
        echo "• Checking for existing project..."
        if railway list --json | jq -r '.[].name' | grep -q "^$PROJECT_NAME$"; then
          echo "• Project $PROJECT_NAME already exists, linking..."
          PROJECT_ID=$(railway list --json | jq -r ".[] | select(.name==\"$PROJECT_NAME\") | .id")
          echo "• Linked to existing project ID: ${PROJECT_ID:0:8}..."
          echo "project-id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "created=false" >> $GITHUB_OUTPUT
        else
          echo "• Creating new project: $PROJECT_NAME"
          railway init --name "$PROJECT_NAME"
          
          # Wait for project creation to propagate
          sleep 2
          
          # Get the created project ID
          PROJECT_ID=$(railway list --json | jq -r ".[] | select(.name==\"$PROJECT_NAME\") | .id")
          
          if [ -n "$PROJECT_ID" ] && [ "$PROJECT_ID" != "null" ]; then
            echo "• Created project with ID: ${PROJECT_ID:0:8}..."
            echo "project-id=$PROJECT_ID" >> $GITHUB_OUTPUT
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to create or find project $PROJECT_NAME"
            exit 1
          fi
        fi
        
        # Export for subsequent steps in same job
        echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
        echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "• Setup completed in ${DURATION}s"
        
        echo "::endgroup::"
      env:
        RAILWAY_API_TOKEN: ${{ inputs.railway-token }}
        CI: true