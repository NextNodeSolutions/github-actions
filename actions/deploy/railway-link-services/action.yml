name: 'Railway Link Services'
description: 'Link Railway services by name with automatic service discovery and reference variable configuration'

inputs:
  linked-services:
    description: |
      Services to link (one per line, priority order).
      First service found will be used.
      Example:
        pr-58_nextnode-cms
        dev_nextnode-cms
    required: true

  project-id:
    description: 'Railway project ID'
    required: true

  environment:
    description: 'Railway environment (e.g., development, production)'
    required: true

  railway-token:
    description: 'Railway API token'
    required: true

  variable-name:
    description: 'Environment variable name to set (e.g., CMS_URL, API_URL)'
    required: true
    default: 'SERVICE_URL'

outputs:
  linked-service:
    description: 'Name of the service that was linked'
    value: ${{ steps.link.outputs.service-name }}

  service-url:
    description: 'Generated service URL'
    value: ${{ steps.link.outputs.service-url }}

runs:
  using: 'composite'
  steps:
    - name: Setup Railway CLI
      shell: bash
      run: |
        echo "::group::üöÇ Installing Railway CLI"
        npm install -g @railway/cli
        CLI_VERSION=$(railway --version)
        echo "‚úÖ Railway CLI installed: $CLI_VERSION"
        echo "::endgroup::"
      env:
        RAILWAY_API_TOKEN: ${{ inputs.railway-token }}
        CI: true

    - name: Link to Railway Project
      shell: bash
      run: |
        echo "::group::Linking to Railway project"
        railway link --project "${{ inputs.project-id }}" --environment "${{ inputs.environment }}"
        echo "::endgroup::"
      env:
        RAILWAY_API_TOKEN: ${{ inputs.railway-token }}
        CI: true

    - name: Find and Link Service
      id: link
      shell: bash
      run: |
        set -e

        VARIABLE_NAME="${{ inputs.variable-name }}"
        ENVIRONMENT="${{ inputs.environment }}"

        # Parse services (one per line)
        IFS=$'\n' read -d '' -r -a SERVICES <<< "${{ inputs.linked-services }}" || true

        echo "::group::Service Discovery"
        echo "Looking for services in environment: $ENVIRONMENT"
        echo "Priority order:"
        printf '%s\n' "${SERVICES[@]}"
        echo "::endgroup::"

        # Try each service in order
        for user_input in "${SERVICES[@]}"; do
          # Skip empty lines
          [[ -z "$user_input" ]] && continue

          # Normalize PR hyphen only: pr58_ ‚Üí pr-58_
          SERVICE_NAME=$(echo "$user_input" | sed -E 's/^pr([0-9]+)_/pr-\1_/')

          echo "::group::Checking service: $SERVICE_NAME"

          if [[ "$SERVICE_NAME" != "$user_input" ]]; then
            echo "Normalized from: $user_input"
          fi

          # Check if service exists (exact match)
          SERVICE_INFO=$(railway status --json 2>/dev/null | \
            jq -r '.services.edges[]? | .node | select(.name=="'"$SERVICE_NAME"'")' 2>/dev/null || echo "{}")

          SERVICE_ID=$(echo "$SERVICE_INFO" | jq -r '.id // empty' 2>/dev/null)

          if [ -n "$SERVICE_ID" ]; then
            echo "‚úÖ Found service: $SERVICE_NAME (ID: $SERVICE_ID)"
            echo "::endgroup::"

            # Set reference variable using Railway's template syntax
            # Railway will resolve ${{service.RAILWAY_PRIVATE_DOMAIN}} and ${{service.PORT}} at runtime
            SERVICE_URL_TEMPLATE=$(printf 'http://${{%s.RAILWAY_PRIVATE_DOMAIN}}:${{%s.PORT}}' "$SERVICE_NAME" "$SERVICE_NAME")

            echo "::group::Setting service reference"
            echo "Variable: $VARIABLE_NAME"
            echo "Template: $SERVICE_URL_TEMPLATE"

            railway variables --set "${VARIABLE_NAME}=${SERVICE_URL_TEMPLATE}"

            echo "::endgroup::"

            # Output
            echo "service-name=$SERVICE_NAME" >> $GITHUB_OUTPUT
            echo "service-url=$SERVICE_URL_TEMPLATE" >> $GITHUB_OUTPUT

            echo "::notice::Successfully linked to service '$SERVICE_NAME' in environment '$ENVIRONMENT'"
            exit 0
          else
            echo "‚è≠Ô∏è  Service not found, trying next..."
            echo "::endgroup::"
          fi
        done

        # No service found
        echo "::group::‚ùå No Service Found"
        echo "Tried the following services in environment '$ENVIRONMENT':"
        printf '%s\n' "${SERVICES[@]}"
        echo "::endgroup::"

        echo "::error::No service found in environment '$ENVIRONMENT'. Check service names and ensure they exist in Railway."
        exit 1
      env:
        RAILWAY_API_TOKEN: ${{ inputs.railway-token }}
        CI: true
