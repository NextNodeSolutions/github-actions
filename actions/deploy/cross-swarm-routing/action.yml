name: 'Cross-Swarm Traefik Routing'
description: 'Auto-configure Traefik for cross-Swarm services when app runs on different server than Traefik'
author: 'NextNodeSolutions'

inputs:
  app-name:
    description: 'Dokploy application name (used for service name and Traefik config)'
    required: true
  domain:
    description: 'Domain to route to this service'
    required: true
  worker-tailscale-ip:
    description: 'Tailscale IP of the worker running the service'
    required: true
  admin-tailscale-ip:
    description: 'Tailscale IP of admin-dokploy (Traefik server)'
    required: true
  container-port:
    description: 'Container port the application listens on'
    required: true
  use-https:
    description: 'Whether to use HTTPS for the domain (with Let''s Encrypt)'
    required: false
    default: 'true'
  ssh-private-key:
    description: 'SSH private key for connecting to servers'
    required: true
  expected-image:
    description: 'Expected Docker image tag (e.g., admin-dokploy:5000/app:abc123). If provided, waits for deployment to complete with this image before adding ports.'
    required: false
    default: ''

outputs:
  external-port:
    description: 'Deterministic external port assigned to this service'
    value: ${{ steps.port.outputs.external-port }}
  traefik-config-path:
    description: 'Path to generated Traefik config file'
    value: ${{ steps.traefik.outputs.traefik-config-path }}

runs:
  using: 'composite'
  steps:
    - name: Publish port on worker
      id: port
      uses: nextnodesolutions/github-actions/actions/deploy/publish-service-port@main
      with:
        app-name: ${{ inputs.app-name }}
        container-port: ${{ inputs.container-port }}
        server-ip: ${{ inputs.worker-tailscale-ip }}
        ssh-private-key: ${{ inputs.ssh-private-key }}
        expected-image: ${{ inputs.expected-image }}

    - name: Deploy Traefik config
      id: traefik
      shell: bash
      run: |
        echo "::group::Deploying Traefik config to admin (${{ inputs.admin-tailscale-ip }})"

        APP_NAME="${{ inputs.app-name }}"
        DOMAIN="${{ inputs.domain }}"
        WORKER_IP="${{ inputs.worker-tailscale-ip }}"
        ADMIN_IP="${{ inputs.admin-tailscale-ip }}"
        EXTERNAL_PORT="${{ steps.port.outputs.external-port }}"
        USE_HTTPS="${{ inputs.use-https }}"

        TRAEFIK_CONFIG_PATH="/var/lib/dokploy/traefik/dynamic/${APP_NAME}.yml"
        echo "traefik-config-path=$TRAEFIK_CONFIG_PATH" >> $GITHUB_OUTPUT

        # Setup SSH key
        mkdir -p ~/.ssh
        echo "${{ inputs.ssh-private-key }}" > ~/.ssh/traefik_config_key
        chmod 600 ~/.ssh/traefik_config_key
        SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/traefik_config_key"

        # Generate Traefik configuration
        if [ "$USE_HTTPS" = "true" ]; then
          cat > /tmp/traefik-config.yml <<EOF
        # Auto-generated by cross-swarm-routing action
        # App: $APP_NAME
        # Worker: $WORKER_IP:$EXTERNAL_PORT -> :${{ inputs.container-port }}
        http:
          routers:
            $APP_NAME:
              rule: "Host(\`$DOMAIN\`)"
              service: "$APP_NAME"
              entryPoints:
                - "websecure"
              tls:
                certResolver: "letsencrypt"
            ${APP_NAME}-http:
              rule: "Host(\`$DOMAIN\`)"
              service: "$APP_NAME"
              entryPoints:
                - "web"
              middlewares:
                - "redirect-https"
          services:
            $APP_NAME:
              loadBalancer:
                servers:
                  - url: "http://$WORKER_IP:$EXTERNAL_PORT"
        EOF
        else
          cat > /tmp/traefik-config.yml <<EOF
        # Auto-generated by cross-swarm-routing action
        # App: $APP_NAME
        # Worker: $WORKER_IP:$EXTERNAL_PORT -> :${{ inputs.container-port }}
        http:
          routers:
            $APP_NAME:
              rule: "Host(\`$DOMAIN\`)"
              service: "$APP_NAME"
              entryPoints:
                - "web"
          services:
            $APP_NAME:
              loadBalancer:
                servers:
                  - url: "http://$WORKER_IP:$EXTERNAL_PORT"
        EOF
        fi

        echo "Generated Traefik config:"
        cat /tmp/traefik-config.yml

        # Copy config to admin server
        scp $SSH_OPTS /tmp/traefik-config.yml root@$ADMIN_IP:$TRAEFIK_CONFIG_PATH

        echo "Traefik config deployed to $TRAEFIK_CONFIG_PATH"
        echo "Traefik will auto-reload via file provider watch"

        # Cleanup
        rm -f /tmp/traefik-config.yml ~/.ssh/traefik_config_key

        echo "::endgroup::"

        echo ""
        echo "Cross-Swarm routing configured successfully!"
        echo "  Domain: $DOMAIN"
        echo "  Route: Traefik ($ADMIN_IP) -> Worker ($WORKER_IP:$EXTERNAL_PORT)"
