name: 'Docker Build and Push'
description: 'Build Docker image and push to private registry via Tailscale'
author: 'NextNodeSolutions'

inputs:
  tailscale-oauth-client-id:
    description: 'Tailscale OAuth client ID for connecting to private network'
    required: true
  tailscale-oauth-secret:
    description: 'Tailscale OAuth secret for connecting to private network'
    required: true
  registry-host:
    description: 'Docker registry hostname'
    default: 'registry.nextnode.fr'
  dockerfile:
    description: 'Path to Dockerfile'
    default: 'Dockerfile'
  context:
    description: 'Docker build context'
    default: '.'
  build-args:
    description: 'Docker build arguments (KEY=VALUE format, one per line)'
    default: ''
  tags:
    description: 'Image tags (comma-separated). Auto-generates if empty.'
    default: ''

outputs:
  image:
    description: 'Full image reference (registry/repo:tag)'
    value: ${{ steps.push.outputs.image }}

runs:
  using: 'composite'
  steps:
    - name: Connect to Tailscale
      uses: nextnodesolutions/github-actions/actions/infrastructure/tailscale-connect@main
      with:
        oauth-client-id: ${{ inputs.tailscale-oauth-client-id }}
        oauth-secret: ${{ inputs.tailscale-oauth-secret }}
        wait-for-hostname: admin-dokploy

    - name: Test Registry Connection
      id: registry
      shell: bash
      env:
        REGISTRY_HOST: ${{ inputs.registry-host }}
      run: |
        echo "::group::Testing registry connection"

        # Get admin-dokploy Tailscale IP (registry runs on this machine)
        # This bypasses DNS resolution issues in GitHub Actions runners
        REGISTRY_IP=$(tailscale status --json | jq -r '.Peer | to_entries[] | select(.value.HostName == "admin-dokploy") | .value.TailscaleIPs[0]')

        if [[ -z "$REGISTRY_IP" || "$REGISTRY_IP" == "null" ]]; then
          echo "::error::Failed to get admin-dokploy IP from Tailscale"
          tailscale status --json | jq '.Peer | to_entries[] | {hostname: .value.HostName, ips: .value.TailscaleIPs}'
          exit 1
        fi

        echo "Registry IP: $REGISTRY_IP"
        echo "registry-ip=$REGISTRY_IP" >> $GITHUB_OUTPUT

        # Debug: check TCP connectivity
        echo "=== TCP Connectivity Tests ==="
        for port in 5000 443 80; do
          if timeout 5 bash -c "echo >/dev/tcp/${REGISTRY_IP}/${port}" 2>/dev/null; then
            echo "TCP ${port}: OPEN"
          else
            echo "TCP ${port}: CLOSED/TIMEOUT"
          fi
        done

        # Debug: verbose curl tests
        echo "=== Curl Tests (verbose) ==="
        echo "--- Port 5000 ---"
        curl -v --connect-timeout 5 "http://${REGISTRY_IP}:5000/v2/" 2>&1 || true

        echo "--- Port 443 (Traefik) ---"
        curl -vk --connect-timeout 5 --resolve "${REGISTRY_HOST}:443:${REGISTRY_IP}" "https://${REGISTRY_HOST}/v2/" 2>&1 || true

        # Try direct connection to registry port 5000
        echo "=== Final Connection Test ==="
        if curl -sf --connect-timeout 10 "http://${REGISTRY_IP}:5000/v2/"; then
          echo "Direct registry connection successful (port 5000)"
          echo "registry-port=5000" >> $GITHUB_OUTPUT
        elif curl --resolve "${REGISTRY_HOST}:443:${REGISTRY_IP}" "https://${REGISTRY_HOST}/v2/" -sfLk --connect-timeout 10; then
          echo "Traefik connection successful (HTTPS)"
          echo "registry-port=443" >> $GITHUB_OUTPUT
        else
          echo "::error::Cannot connect to registry at ${REGISTRY_IP}"
          exit 1
        fi
        echo "::endgroup::"

    # SECURITY: network=host is required for Tailscale connectivity to private registry.
    # The registry (admin-dokploy:5000) is only accessible via Tailscale network.
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: Generate Image Tag
      id: tag
      shell: bash
      env:
        CUSTOM_TAGS: ${{ inputs.tags }}
        REGISTRY_HOST: ${{ inputs.registry-host }}
        REGISTRY_IP: ${{ steps.registry.outputs.registry-ip }}
        REGISTRY_PORT: ${{ steps.registry.outputs.registry-port }}
      run: |
        echo "::group::Generating image tag"
        REPO_NAME="${GITHUB_REPOSITORY#*/}"
        SHA_SHORT="${GITHUB_SHA:0:7}"

        if [ -n "$CUSTOM_TAGS" ]; then
          FIRST_TAG="${CUSTOM_TAGS%%,*}"
        else
          FIRST_TAG="${SHA_SHORT}"
        fi

        # For Dokploy (uses hostname-based reference)
        IMAGE="${REGISTRY_HOST}/${REPO_NAME}:${FIRST_TAG}"
        echo "image=${IMAGE}" >> $GITHUB_OUTPUT

        # For push (use direct IP:port if available, otherwise hostname)
        if [ "$REGISTRY_PORT" = "5000" ]; then
          PUSH_IMAGE="${REGISTRY_IP}:5000/${REPO_NAME}:${FIRST_TAG}"
        else
          PUSH_IMAGE="${REGISTRY_HOST}/${REPO_NAME}:${FIRST_TAG}"
        fi
        echo "push-image=${PUSH_IMAGE}" >> $GITHUB_OUTPUT

        echo "Dokploy image: ${IMAGE}"
        echo "Push target: ${PUSH_IMAGE}"
        echo "::endgroup::"

    - name: Build and Push
      id: push
      shell: bash
      env:
        DOCKERFILE: ${{ inputs.dockerfile }}
        CONTEXT: ${{ inputs.context }}
        BUILD_ARGS: ${{ inputs.build-args }}
        IMAGE: ${{ steps.tag.outputs.image }}
        PUSH_IMAGE: ${{ steps.tag.outputs.push-image }}
        REGISTRY_HOST: ${{ inputs.registry-host }}
        REGISTRY_IP: ${{ steps.registry.outputs.registry-ip }}
        REGISTRY_PORT: ${{ steps.registry.outputs.registry-port }}
      run: |
        echo "::group::Building and pushing Docker image"

        BUILD_ARGS_FLAGS=""
        if [ -n "$BUILD_ARGS" ]; then
          while IFS= read -r arg; do
            [ -n "$arg" ] && BUILD_ARGS_FLAGS="$BUILD_ARGS_FLAGS --build-arg $arg"
          done <<< "$BUILD_ARGS"
        fi

        # Build with push target (direct IP:5000 or hostname via Traefik)
        if [ "$REGISTRY_PORT" = "5000" ]; then
          # Direct push to registry (HTTP, insecure)
          docker buildx build \
            --file "$DOCKERFILE" \
            --tag "$PUSH_IMAGE" \
            --push \
            --network=host \
            $BUILD_ARGS_FLAGS \
            "$CONTEXT"
        else
          # Push via Traefik (HTTPS with --add-host for DNS)
          docker buildx build \
            --file "$DOCKERFILE" \
            --tag "$PUSH_IMAGE" \
            --add-host "${REGISTRY_HOST}:${REGISTRY_IP}" \
            --push \
            --network=host \
            $BUILD_ARGS_FLAGS \
            "$CONTEXT"
        fi

        # Output hostname-based image for Dokploy
        echo "image=${IMAGE}" >> $GITHUB_OUTPUT
        echo "Pushed: ${PUSH_IMAGE}"
        echo "Dokploy will pull: ${IMAGE}"
        echo "::endgroup::"
