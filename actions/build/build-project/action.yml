name: 'Build Project'
description: 'Atomic action to build projects using pnpm'
inputs:
  working-directory:
    description: 'Working directory'
    required: false
    default: '.'
  build-command:
    description: 'Build command to run'
    required: false
    default: 'build'
  output-directory:
    description: 'Expected output directory'
    required: false
    default: 'dist'
  env-vars:
    description: 'Environment variables as JSON'
    required: false
    default: '{}'
  enable-timing:
    description: 'Show timing information'
    required: false
    default: 'true'

outputs:
  build-time:
    description: 'Time taken to build'
    value: ${{ steps.build.outputs.build-time }}
  output-size:
    description: 'Size of build output'
    value: ${{ steps.analyze.outputs.output-size }}
  success:
    description: 'Whether build succeeded'
    value: ${{ steps.build.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Setup environment
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        INPUT_WORKING_DIR: ${{ inputs.working-directory }}
        INPUT_BUILD_COMMAND: ${{ inputs.build-command }}
        INPUT_OUTPUT_DIR: ${{ inputs.output-directory }}
        INPUT_ENV_VARS: ${{ inputs.env-vars }}
      run: |
        echo "::group::ğŸ—ï¸ Build Setup"
        echo "â€¢ Working directory: $INPUT_WORKING_DIR"
        echo "â€¢ Build command: pnpm $INPUT_BUILD_COMMAND"
        echo "â€¢ Output directory: $INPUT_OUTPUT_DIR"

        # Set environment variables if provided (with validation)
        if [[ "$INPUT_ENV_VARS" != '{}' ]]; then
          echo "â€¢ Setting environment variables:"
          # Validate JSON first
          if ! echo "$INPUT_ENV_VARS" | jq -e . >/dev/null 2>&1; then
            echo "âŒ Invalid JSON in env-vars"
            exit 1
          fi
          # Validate and set each variable safely
          while IFS='=' read -r key value; do
            # Validate key (alphanumeric and underscore only)
            if [[ ! "$key" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]]; then
              echo "âŒ Invalid environment variable name: $key"
              exit 1
            fi
            # Validate value doesn't contain newlines (GITHUB_ENV injection prevention)
            if [[ "$value" == *$'\n'* ]]; then
              echo "âŒ Environment variable value cannot contain newlines: $key"
              exit 1
            fi
            echo "  - $key=$value"
            echo "$key=$value" >> $GITHUB_ENV
          done < <(echo "$INPUT_ENV_VARS" | jq -r 'to_entries[] | "\(.key)=\(.value)"')
        fi

        echo "::endgroup::"

    - name: Execute build
      id: build
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        INPUT_BUILD_COMMAND: ${{ inputs.build-command }}
      run: |
        echo "::group::âš™ï¸ Building Project"

        # Validate build command (alphanumeric, dash, colon only)
        if [[ ! "$INPUT_BUILD_COMMAND" =~ ^[a-zA-Z0-9_:-]+$ ]]; then
          echo "âŒ Invalid build command: contains unsafe characters"
          exit 1
        fi

        START_TIME=$(date +%s)

        # Run build command
        echo "â€¢ Executing: pnpm $INPUT_BUILD_COMMAND"
        if pnpm "$INPUT_BUILD_COMMAND"; then
          BUILD_SUCCESS="true"
          echo "âœ… Build completed successfully"
        else
          BUILD_SUCCESS="false"
          echo "âŒ Build failed"
          exit 1
        fi

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        echo "â€¢ Build time: ${DURATION}s"
        echo "build-time=${DURATION}s" >> $GITHUB_OUTPUT
        echo "success=$BUILD_SUCCESS" >> $GITHUB_OUTPUT

        echo "::endgroup::"

    - name: Analyze build output
      id: analyze
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        INPUT_OUTPUT_DIR: ${{ inputs.output-directory }}
      run: |
        echo "::group::ğŸ“Š Build Analysis"

        # Validate output directory path
        if [[ ! "$INPUT_OUTPUT_DIR" =~ ^[a-zA-Z0-9_./-]+$ ]]; then
          echo "âŒ Invalid output directory: contains unsafe characters"
          exit 1
        fi

        # Check if output directory exists
        if [[ -d "$INPUT_OUTPUT_DIR" ]]; then
          # Calculate output size
          OUTPUT_SIZE=$(du -sh "$INPUT_OUTPUT_DIR" | cut -f1)
          echo "â€¢ Output size: $OUTPUT_SIZE"
          echo "output-size=$OUTPUT_SIZE" >> $GITHUB_OUTPUT

          # Count files
          FILE_COUNT=$(find "$INPUT_OUTPUT_DIR" -type f | wc -l | tr -d ' ')
          echo "â€¢ Files generated: $FILE_COUNT"

          # List largest files (use pipe handling to avoid broken pipe errors)
          echo "â€¢ Largest files:"
          LARGEST_FILES=$(find "$INPUT_OUTPUT_DIR" -type f -exec du -h {} \; 2>/dev/null | sort -rh 2>/dev/null | head -5 2>/dev/null || true)
          if [[ -n "$LARGEST_FILES" ]]; then
            echo "$LARGEST_FILES" | while read -r size file; do
              echo "  - $size $(basename "$file")"
            done
          fi
        else
          echo "âš ï¸ Output directory '$INPUT_OUTPUT_DIR' not found"
          echo "output-size=N/A" >> $GITHUB_OUTPUT
        fi

        echo "::endgroup::"

    - name: Summary
      shell: bash
      run: |
        echo "::group::ğŸ“ Build Summary"
        echo "â€¢ Status: ${{ steps.build.outputs.success == 'true' && 'âœ… Success' || 'âŒ Failed' }}"
        echo "â€¢ Duration: ${{ steps.build.outputs.build-time }}"
        echo "â€¢ Output size: ${{ steps.analyze.outputs.output-size }}"
        echo "::endgroup::"