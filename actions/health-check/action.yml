name: 'Health Check'
description: 'Perform health check on a URL with retries'
inputs:
  url:
    description: 'URL to check'
    required: true
  max-attempts:
    description: 'Maximum number of attempts'
    required: false
    default: '30'
  delay-seconds:
    description: 'Delay between attempts in seconds'
    required: false
    default: '10'
  expected-status:
    description: 'Expected HTTP status code (comma-separated for multiple)'
    required: false
    default: '200,201,204,301,302'
  timeout-seconds:
    description: 'Request timeout in seconds'
    required: false
    default: '30'
  fail-on-error:
    description: 'Fail the action if health check fails'
    required: false
    default: 'true'
  headers:
    description: 'Additional headers as JSON object'
    required: false
    default: '{}'

outputs:
  healthy:
    description: 'Whether the health check passed'
    value: ${{ steps.check.outputs.healthy }}
  status-code:
    description: 'Final HTTP status code'
    value: ${{ steps.check.outputs.status-code }}
  response-time:
    description: 'Response time in milliseconds'
    value: ${{ steps.check.outputs.response-time }}
  attempts:
    description: 'Number of attempts made'
    value: ${{ steps.check.outputs.attempts }}

runs:
  using: 'composite'
  steps:
    - name: Perform Health Check
      id: check
      shell: bash
      env:
        INPUT_URL: ${{ inputs.url }}
        INPUT_MAX_ATTEMPTS: ${{ inputs.max-attempts }}
        INPUT_DELAY: ${{ inputs.delay-seconds }}
        INPUT_TIMEOUT: ${{ inputs.timeout-seconds }}
        INPUT_EXPECTED_STATUS: ${{ inputs.expected-status }}
        INPUT_HEADERS: ${{ inputs.headers }}
        INPUT_FAIL_ON_ERROR: ${{ inputs.fail-on-error }}
      run: |
        echo "::group::ðŸ¥ Health Check for $INPUT_URL"

        URL="$INPUT_URL"
        MAX_ATTEMPTS="$INPUT_MAX_ATTEMPTS"
        DELAY="$INPUT_DELAY"
        TIMEOUT="$INPUT_TIMEOUT"
        EXPECTED_STATUS="$INPUT_EXPECTED_STATUS"
        HEADERS="$INPUT_HEADERS"

        # Validate numeric inputs
        if [[ ! "$MAX_ATTEMPTS" =~ ^[0-9]+$ ]]; then
          echo "âŒ Invalid max-attempts: must be a number"
          exit 1
        fi
        if [[ ! "$DELAY" =~ ^[0-9]+$ ]]; then
          echo "âŒ Invalid delay-seconds: must be a number"
          exit 1
        fi
        if [[ ! "$TIMEOUT" =~ ^[0-9]+$ ]]; then
          echo "âŒ Invalid timeout-seconds: must be a number"
          exit 1
        fi
        
        # Build curl headers
        CURL_HEADERS=""
        if [[ "$HEADERS" != "{}" ]] && echo "$HEADERS" | jq -e . >/dev/null 2>&1; then
          while IFS= read -r header; do
            CURL_HEADERS="$CURL_HEADERS -H '$header'"
          done < <(echo "$HEADERS" | jq -r 'to_entries | .[] | "\(.key): \(.value)"')
        fi
        
        echo "ðŸ“‹ Configuration:"
        echo "  â€¢ Max attempts: $MAX_ATTEMPTS"
        echo "  â€¢ Delay: ${DELAY}s"
        echo "  â€¢ Timeout: ${TIMEOUT}s"
        echo "  â€¢ Expected status: $EXPECTED_STATUS"
        echo ""
        
        ATTEMPT=0
        HEALTHY=false
        FINAL_STATUS=""
        RESPONSE_TIME=""

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."

          # Perform the health check
          START_TIME=$(date +%s)

          set +e  # Don't exit on curl failure
          RESPONSE=$(curl -s -o /dev/null -w '%{http_code}' --max-time $TIMEOUT "$URL" 2>&1)
          CURL_EXIT_CODE=$?
          set -e

          if [ $CURL_EXIT_CODE -eq 0 ]; then
            END_TIME=$(date +%s)
            RESPONSE_TIME=$((END_TIME - START_TIME))

            echo "  Response: HTTP $RESPONSE (${RESPONSE_TIME}s)"

            # Check if status is in expected list
            if [[ ",$EXPECTED_STATUS," == *",$RESPONSE,"* ]]; then
              echo "âœ… Health check passed!"
              HEALTHY=true
              FINAL_STATUS=$RESPONSE
              break
            else
              echo "  âš ï¸  Unexpected status code: $RESPONSE"
            fi
          else
            echo "  âŒ Request failed: $RESPONSE (exit code: $CURL_EXIT_CODE)"
          fi
          
          if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
            echo "  Waiting ${DELAY}s before retry..."
            sleep $DELAY
          fi
        done
        
        echo ""
        if [[ "$HEALTHY" == "true" ]]; then
          echo "âœ… Health check successful after $ATTEMPT attempt(s)"
          echo "  â€¢ Status: HTTP $FINAL_STATUS"
          echo "  â€¢ Response time: ${RESPONSE_TIME}s"
        else
          echo "âŒ Health check failed after $ATTEMPT attempt(s)"
          if [[ "$INPUT_FAIL_ON_ERROR" == "true" ]]; then
            echo "::endgroup::"
            exit 1
          fi
        fi
        
        # Set outputs
        echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
        echo "status-code=$FINAL_STATUS" >> $GITHUB_OUTPUT
        echo "response-time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
        echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"