name: 'Dokploy Initialize Workers'
description: 'Auto-setup Dokploy and register remote servers as workers. Composes atomic actions: dokploy-admin-setup, dokploy-registry-setup, dokploy-ssh-key-import, dokploy-server-register'
author: 'NextNodeSolutions'

inputs:
  dokploy-url:
    description: 'Dokploy instance URL (e.g., https://admin.nextnode.fr)'
    required: true
  dokploy-admin-email:
    description: 'Dokploy admin email (for first-time setup only)'
    required: true
  dokploy-admin-password:
    description: 'Dokploy admin password (for first-time setup only)'
    required: true
  dokploy-ssh-private-key:
    description: 'SSH private key to import into Dokploy for worker access'
    required: true
  tailscale-api-token:
    description: 'Tailscale API token for worker IP resolution'
    required: true
  target:
    description: 'Target server(s) to initialize: all, dev-worker, prod-worker'
    required: false
    default: 'all'
  max-retries:
    description: 'Max retries for Tailscale IP resolution'
    required: false
    default: '12'
  retry-delay:
    description: 'Delay between retries in seconds'
    required: false
    default: '10'

outputs:
  success:
    description: 'Whether initialization succeeded'
    value: ${{ steps.result.outputs.success }}
  initialized-workers:
    description: 'Comma-separated list of initialized workers'
    value: ${{ steps.result.outputs.initialized-workers }}
  first-time-setup:
    description: 'Whether this was first-time Dokploy setup'
    value: ${{ steps.admin-setup.outputs.setup-completed }}

runs:
  using: 'composite'
  steps:
    # SEC-002: Mask pass-through secrets at parent level
    # This ensures secrets are masked before being passed to child actions
    - name: Mask Sensitive Inputs
      shell: bash
      run: |
        echo "::add-mask::${{ inputs.dokploy-admin-password }}"
        echo "::add-mask::${{ inputs.dokploy-ssh-private-key }}"

    # Step 1: Admin setup (waits for Dokploy, creates admin if first time)
    - name: Setup Dokploy Admin
      id: admin-setup
      uses: nextnodesolutions/github-actions/actions/infrastructure/dokploy-admin-setup@main
      with:
        dokploy-url: ${{ inputs.dokploy-url }}
        admin-email: ${{ inputs.dokploy-admin-email }}
        admin-password: ${{ inputs.dokploy-admin-password }}

    # Step 2: Authenticate with session cookies (for legacy sub-actions)
    - name: Authenticate with Dokploy (Session)
      id: auth
      shell: bash
      env:
        DOKPLOY_URL: ${{ inputs.dokploy-url }}
        ADMIN_EMAIL: ${{ inputs.dokploy-admin-email }}
        ADMIN_PASSWORD: ${{ inputs.dokploy-admin-password }}
      run: |
        echo "::group::Dokploy Session Authentication"

        # SEC-002: Ensure password is masked
        echo "::add-mask::${ADMIN_PASSWORD}"

        COOKIE_JAR="/tmp/dokploy_cookies_$$.txt"
        echo "cookie-jar=$COOKIE_JAR" >> $GITHUB_OUTPUT

        LOGIN_RESPONSE=$(curl -s -c "$COOKIE_JAR" -X POST "${DOKPLOY_URL}/api/auth/sign-in/email" \
          -H "Content-Type: application/json" \
          -d "{\"email\": \"${ADMIN_EMAIL}\", \"password\": \"${ADMIN_PASSWORD}\"}")

        if ! echo "$LOGIN_RESPONSE" | jq -e '.token' > /dev/null 2>&1; then
          echo "::error::Failed to authenticate with Dokploy"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 1
        fi

        echo "Authentication successful"

        # Get organization ID
        ORGANIZATION_ID=$(echo "$LOGIN_RESPONSE" | jq -r '.user.activeOrganizationId // empty')
        if [[ -z "$ORGANIZATION_ID" ]]; then
          ORGANIZATION_ID=$(echo "$LOGIN_RESPONSE" | jq -r '.user.organizationId // empty')
        fi
        if [[ -z "$ORGANIZATION_ID" ]]; then
          SESSION_RESPONSE=$(curl -s -b "$COOKIE_JAR" "${DOKPLOY_URL}/api/auth/get-session")
          ORGANIZATION_ID=$(echo "$SESSION_RESPONSE" | jq -r '.session.activeOrganizationId // .user.activeOrganizationId // empty')
        fi
        if [[ -z "$ORGANIZATION_ID" ]]; then
          ORG_RESPONSE=$(curl -s -b "$COOKIE_JAR" "${DOKPLOY_URL}/api/organization.all")
          ORGANIZATION_ID=$(echo "$ORG_RESPONSE" | jq -r '.[0].organizationId // .[0].id // empty')
        fi

        if [[ -z "$ORGANIZATION_ID" ]]; then
          echo "::error::Could not get organization ID"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 1
        fi

        echo "Organization ID: $ORGANIZATION_ID"
        echo "organization-id=$ORGANIZATION_ID" >> $GITHUB_OUTPUT
        echo "success=true" >> $GITHUB_OUTPUT

        echo "::endgroup::"

    # Step 3: Configure internal Docker registry
    - name: Configure Registry
      id: registry
      uses: nextnodesolutions/github-actions/actions/infrastructure/dokploy-registry-setup@main
      with:
        dokploy-url: ${{ inputs.dokploy-url }}
        cookie-jar: ${{ steps.auth.outputs.cookie-jar }}

    # Step 4: Import SSH key
    - name: Import SSH Key
      id: ssh-key
      uses: nextnodesolutions/github-actions/actions/infrastructure/dokploy-ssh-key-import@main
      with:
        dokploy-url: ${{ inputs.dokploy-url }}
        cookie-jar: ${{ steps.auth.outputs.cookie-jar }}
        ssh-private-key: ${{ inputs.dokploy-ssh-private-key }}
        organization-id: ${{ steps.auth.outputs.organization-id }}

    # Step 5: Lookup dev-worker in Tailscale
    - name: Lookup dev-worker
      id: dev-worker-lookup
      if: inputs.target == 'all' || inputs.target == 'dev-worker'
      uses: nextnodesolutions/github-actions/actions/utilities/tailscale-device-lookup@main
      with:
        hostname: 'dev-worker'
        tailscale-api-key: ${{ inputs.tailscale-api-token }}
        max-retries: ${{ inputs.max-retries }}
        retry-delay: ${{ inputs.retry-delay }}

    # Step 6: Lookup prod-worker in Tailscale
    - name: Lookup prod-worker
      id: prod-worker-lookup
      if: inputs.target == 'all' || inputs.target == 'prod-worker'
      uses: nextnodesolutions/github-actions/actions/utilities/tailscale-device-lookup@main
      with:
        hostname: 'prod-worker'
        tailscale-api-key: ${{ inputs.tailscale-api-token }}
        max-retries: ${{ inputs.max-retries }}
        retry-delay: ${{ inputs.retry-delay }}

    # Step 7: Register dev-worker
    - name: Register dev-worker
      id: dev-worker-register
      if: (inputs.target == 'all' || inputs.target == 'dev-worker') && steps.dev-worker-lookup.outputs.exists == 'true'
      uses: nextnodesolutions/github-actions/actions/infrastructure/dokploy-server-register@main
      with:
        dokploy-url: ${{ inputs.dokploy-url }}
        cookie-jar: ${{ steps.auth.outputs.cookie-jar }}
        server-name: dev-worker
        server-ip: ${{ steps.dev-worker-lookup.outputs.ip-address }}
        ssh-key-id: ${{ steps.ssh-key.outputs.ssh-key-id }}

    # Step 8: Register prod-worker
    - name: Register prod-worker
      id: prod-worker-register
      if: (inputs.target == 'all' || inputs.target == 'prod-worker') && steps.prod-worker-lookup.outputs.exists == 'true'
      uses: nextnodesolutions/github-actions/actions/infrastructure/dokploy-server-register@main
      with:
        dokploy-url: ${{ inputs.dokploy-url }}
        cookie-jar: ${{ steps.auth.outputs.cookie-jar }}
        server-name: prod-worker
        server-ip: ${{ steps.prod-worker-lookup.outputs.ip-address }}
        ssh-key-id: ${{ steps.ssh-key.outputs.ssh-key-id }}

    # Step 9: Collect results
    - name: Collect Results
      id: result
      shell: bash
      run: |
        echo "::group::Worker Registration Results"

        INITIALIZED=""

        # Check dev-worker result
        if [[ "${{ steps.dev-worker-register.outputs.success }}" == "true" ]]; then
          echo "dev-worker: success (server-id: ${{ steps.dev-worker-register.outputs.server-id }})"
          INITIALIZED="dev-worker"
        elif [[ "${{ inputs.target }}" == "all" || "${{ inputs.target }}" == "dev-worker" ]]; then
          if [[ "${{ steps.dev-worker-lookup.outputs.exists }}" != "true" ]]; then
            echo "::warning::dev-worker not found in Tailscale, skipping"
          else
            echo "::warning::dev-worker registration did not complete"
          fi
        fi

        # Check prod-worker result
        if [[ "${{ steps.prod-worker-register.outputs.success }}" == "true" ]]; then
          echo "prod-worker: success (server-id: ${{ steps.prod-worker-register.outputs.server-id }})"
          if [[ -n "$INITIALIZED" ]]; then
            INITIALIZED="${INITIALIZED},prod-worker"
          else
            INITIALIZED="prod-worker"
          fi
        elif [[ "${{ inputs.target }}" == "all" || "${{ inputs.target }}" == "prod-worker" ]]; then
          if [[ "${{ steps.prod-worker-lookup.outputs.exists }}" != "true" ]]; then
            echo "::warning::prod-worker not found in Tailscale, skipping"
          else
            echo "::warning::prod-worker registration did not complete"
          fi
        fi

        echo ""
        echo "=== Initialization complete ==="
        echo "Initialized workers: ${INITIALIZED:-none}"

        echo "success=true" >> $GITHUB_OUTPUT
        echo "initialized-workers=${INITIALIZED}" >> $GITHUB_OUTPUT

        echo "::endgroup::"
