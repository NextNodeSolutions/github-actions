name: 'Dokploy SSH Key Import'
description: 'Import SSH key to Dokploy for server access'
author: 'NextNodeSolutions'

inputs:
  dokploy-url:
    description: 'Dokploy instance URL'
    required: true
  cookie-jar:
    description: 'Path to cookie jar file for session auth'
    required: true
  ssh-private-key:
    description: 'SSH private key to import'
    required: true
  key-name:
    description: 'Name for the SSH key in Dokploy'
    required: false
    default: 'nextnode-dokploy-ci'
  organization-id:
    description: 'Dokploy organization ID'
    required: true

outputs:
  ssh-key-id:
    description: 'The SSH key ID in Dokploy'
    value: ${{ steps.import.outputs.ssh-key-id }}
  created:
    description: 'Whether a new key was created (false if already existed)'
    value: ${{ steps.import.outputs.created }}
  success:
    description: 'Whether the operation succeeded'
    value: ${{ steps.import.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Import SSH Key
      id: import
      shell: bash
      env:
        DOKPLOY_URL: ${{ inputs.dokploy-url }}
        COOKIE_JAR: ${{ inputs.cookie-jar }}
        SSH_PRIVATE_KEY: ${{ inputs.ssh-private-key }}
        KEY_NAME: ${{ inputs.key-name }}
        ORGANIZATION_ID: ${{ inputs.organization-id }}
      run: |
        echo "::group::Dokploy SSH Key Import"

        # SEC-002: Mask sensitive values FIRST (GitHub Actions best practice)
        # This prevents the SSH private key from appearing in logs
        echo "::add-mask::${SSH_PRIVATE_KEY}"

        # Check if key already exists
        EXISTING_KEYS=$(curl -s -b "$COOKIE_JAR" "${DOKPLOY_URL}/api/sshKey.all" \
          -H "Content-Type: application/json")

        EXISTING_KEY_ID=$(echo "$EXISTING_KEYS" | jq -r ".[] | select(.name == \"$KEY_NAME\") | .sshKeyId" 2>/dev/null || echo "")

        if [[ -n "$EXISTING_KEY_ID" ]]; then
          echo "SSH key already exists: $EXISTING_KEY_ID"
          echo "ssh-key-id=$EXISTING_KEY_ID" >> $GITHUB_OUTPUT
          echo "created=false" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 0
        fi

        echo "Importing SSH key: $KEY_NAME"

        # SEC-002: Use trap for guaranteed cleanup on exit/error
        # PID-based temp file prevents conflicts in parallel runs
        cleanup() { rm -f /tmp/dokploy_key_$$; }
        trap cleanup EXIT

        # Extract public key from private key
        # Write key to temp file with unique PID-based name
        echo "$SSH_PRIVATE_KEY" > /tmp/dokploy_key_$$
        chmod 600 /tmp/dokploy_key_$$
        PUBLIC_KEY=$(ssh-keygen -y -f /tmp/dokploy_key_$$ 2>/dev/null)

        if [[ -z "$PUBLIC_KEY" ]]; then
          echo "::error::Failed to extract public key from private key"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 1
        fi

        # SEC-002: Use --rawfile to read private key from file instead of passing via command line
        # This avoids exposing the key in process args (visible via ps)
        CREATE_DATA=$(jq -n \
          --arg name "$KEY_NAME" \
          --arg publicKey "$PUBLIC_KEY" \
          --arg organizationId "$ORGANIZATION_ID" \
          --rawfile privateKey /tmp/dokploy_key_$$ \
          '{name: $name, publicKey: $publicKey, privateKey: $privateKey, organizationId: $organizationId}')

        WRAPPED_DATA="{\"0\":{\"json\":${CREATE_DATA}}}"

        curl -s -b "$COOKIE_JAR" -X POST "${DOKPLOY_URL}/api/trpc/sshKey.create?batch=1" \
          -H "Content-Type: application/json" \
          -d "$WRAPPED_DATA" > /dev/null

        # Verify key was created
        sleep 1
        CREATED_KEYS=$(curl -s -b "$COOKIE_JAR" "${DOKPLOY_URL}/api/sshKey.all" \
          -H "Content-Type: application/json")

        SSH_KEY_ID=$(echo "$CREATED_KEYS" | jq -r ".[] | select(.name == \"$KEY_NAME\") | .sshKeyId" 2>/dev/null || echo "")

        if [[ -z "$SSH_KEY_ID" ]]; then
          echo "::error::Failed to import SSH key - key not found after creation"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 1
        fi

        echo "SSH key imported: $SSH_KEY_ID"
        echo "ssh-key-id=$SSH_KEY_ID" >> $GITHUB_OUTPUT
        echo "created=true" >> $GITHUB_OUTPUT
        echo "success=true" >> $GITHUB_OUTPUT

        echo "::endgroup::"
