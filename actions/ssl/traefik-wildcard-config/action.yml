name: 'Traefik Wildcard Config'
description: 'Configure Traefik with wildcard certificate for a domain via dynamic config file'
author: 'NextNodeSolutions'

inputs:
  domain:
    description: 'Full domain (e.g., dev.kicked.dev)'
    required: true
  router-name:
    description: 'Traefik router name (used for config file and router ID)'
    required: true
  traefik-server-ip:
    description: 'Tailscale IP of the Traefik server'
    required: true
  container-port:
    description: 'Container port the application listens on'
    required: false
    default: '3000'
  backend-url:
    description: 'Backend URL for load balancer (if not using local service). If empty, assumes Dokploy handles routing.'
    required: false
    default: ''
  use-https:
    description: 'Whether to configure HTTPS with Let''s Encrypt'
    required: false
    default: 'true'

outputs:
  root-domain:
    description: 'Extracted root domain (e.g., kicked.dev from dev.kicked.dev)'
    value: ${{ steps.extract.outputs.root-domain }}
  config-file:
    description: 'Path to generated Traefik config file on server'
    value: ${{ steps.deploy.outputs.config-file }}
  success:
    description: 'Whether configuration was deployed successfully'
    value: ${{ steps.deploy.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Extract root domain
      id: extract
      shell: bash
      env:
        DOMAIN: ${{ inputs.domain }}
      run: |
        echo "::group::Extracting root domain from $DOMAIN"

        # Split domain by dots and take last 2 parts
        # dev.kicked.dev -> kicked.dev
        # pr-123.dev.nextnode.fr -> nextnode.fr
        # secrets.nextnode.fr -> nextnode.fr
        # kicked.dev -> kicked.dev
        ROOT_DOMAIN=$(echo "$DOMAIN" | awk -F. '{if(NF>=2) print $(NF-1)"."$NF; else print $0}')

        echo "Input domain: $DOMAIN"
        echo "Root domain: $ROOT_DOMAIN"
        echo "root-domain=$ROOT_DOMAIN" >> $GITHUB_OUTPUT

        echo "::endgroup::"

    - name: Deploy Traefik wildcard config
      id: deploy
      shell: bash
      env:
        DOMAIN: ${{ inputs.domain }}
        ROOT_DOMAIN: ${{ steps.extract.outputs.root-domain }}
        ROUTER_NAME: ${{ inputs.router-name }}
        TRAEFIK_IP: ${{ inputs.traefik-server-ip }}
        CONTAINER_PORT: ${{ inputs.container-port }}
        BACKEND_URL: ${{ inputs.backend-url }}
        USE_HTTPS: ${{ inputs.use-https }}
      run: |
        echo "::group::Deploying Traefik wildcard config"

        # Use root domain as config file name to allow cert sharing across subdomains
        SAFE_ROOT_DOMAIN=$(echo "$ROOT_DOMAIN" | tr '.' '-')
        CONFIG_FILE="/etc/traefik/dynamic/wildcard-${SAFE_ROOT_DOMAIN}.yml"
        echo "config-file=$CONFIG_FILE" >> $GITHUB_OUTPUT

        if [[ "$USE_HTTPS" != "true" ]]; then
          echo "HTTPS disabled, skipping wildcard cert config"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 0
        fi

        # Check if wildcard config already exists for this root domain
        echo "Checking if wildcard config exists for $ROOT_DOMAIN..."
        EXISTING=$(tailscale ssh "root@${TRAEFIK_IP}" "test -f ${CONFIG_FILE} && echo 'exists' || echo 'missing'" 2>/dev/null || echo "error")

        if [[ "$EXISTING" == "exists" ]]; then
          echo "Wildcard config already exists for $ROOT_DOMAIN"
          echo "  Config: $CONFIG_FILE"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 0
        fi

        # Generate Traefik dynamic configuration for wildcard cert
        # Uses tls.stores.default.defaultGeneratedCert for automatic wildcard
        cat > /tmp/traefik-wildcard-config.yml <<EOF
        # Auto-generated wildcard certificate config
        # Root domain: $ROOT_DOMAIN
        # Generated by traefik-wildcard-config action
        #
        # This tells Traefik to request ONE wildcard cert for *.${ROOT_DOMAIN}
        # All subdomains (dev., pr-123., etc.) automatically use this cert
        tls:
          stores:
            default:
              defaultGeneratedCert:
                resolver: letsencrypt
                domain:
                  main: ${ROOT_DOMAIN}
                  sans:
                    - "*.${ROOT_DOMAIN}"
        EOF

        echo "Generated Traefik config:"
        cat /tmp/traefik-wildcard-config.yml

        # Deploy config to Traefik server via Tailscale SSH
        echo ""
        echo "Deploying to $TRAEFIK_IP:$CONFIG_FILE"

        if ! cat /tmp/traefik-wildcard-config.yml | tailscale ssh "root@${TRAEFIK_IP}" "cat > ${CONFIG_FILE}"; then
          echo "::error::Failed to deploy Traefik config to ${TRAEFIK_IP}"
          echo "success=false" >> $GITHUB_OUTPUT
          rm -f /tmp/traefik-wildcard-config.yml
          echo "::endgroup::"
          exit 1
        fi

        rm -f /tmp/traefik-wildcard-config.yml

        echo ""
        echo "Wildcard certificate configured successfully!"
        echo "  Root domain: $ROOT_DOMAIN"
        echo "  Wildcard: *.$ROOT_DOMAIN"
        echo "  Config: $CONFIG_FILE"
        echo "success=true" >> $GITHUB_OUTPUT

        echo "::endgroup::"
