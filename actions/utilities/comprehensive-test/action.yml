name: 'Comprehensive Test Runner'
description: 'Centralized testing logic for actions and workflows with dependency validation'
author: 'NextNodeSolutions'

inputs:
  test-mode:
    description: 'Test mode: atomic-action, pack-workflow, or integration'
    required: true
    type: string
  target-path:
    description: 'Path to the action or workflow to test'
    required: false
    default: ''
  working-directory:
    description: 'Working directory for test project'
    required: false
    default: 'test-project'
  test-name:
    description: 'Name of the test for logging'
    required: false
    default: 'Test'
  validate-dependencies:
    description: 'Whether to validate action dependencies'
    required: false
    default: 'true'
  create-test-project:
    description: 'Whether to create a test project'
    required: false
    default: 'true'
  available-actions:
    description: 'JSON array of available actions from discovery (for reference validation)'
    required: false
    default: '[]'
  enable-reference-validation:
    description: 'Enable validation of uses: references'
    required: false
    default: 'false'

outputs:
  test-result:
    description: 'Test result: success or failure'
    value: ${{ steps.run-test.outputs.result }}
  test-details:
    description: 'Detailed test information'
    value: ${{ steps.run-test.outputs.details }}

runs:
  using: 'composite'
  steps:
    - name: Setup test environment
      id: setup
      shell: bash
      run: |
        echo "::group::üîß Setting Up Test Environment"
        
        TEST_MODE="${{ inputs.test-mode }}"
        TARGET_PATH="${{ inputs.target-path }}"
        WORKING_DIR="${{ inputs.working-directory }}"
        TEST_NAME="${{ inputs.test-name }}"
        
        echo "‚Ä¢ Test mode: $TEST_MODE"
        echo "‚Ä¢ Target path: $TARGET_PATH"
        echo "‚Ä¢ Working directory: $WORKING_DIR" 
        echo "‚Ä¢ Test name: $TEST_NAME"
        
        # Validate test mode
        case "$TEST_MODE" in
          atomic-action|pack-workflow|integration)
            echo "‚úÖ Valid test mode"
            ;;
          *)
            echo "‚ùå Invalid test mode: $TEST_MODE"
            echo "Valid modes: atomic-action, pack-workflow, integration"
            exit 1
            ;;
        esac
        
        echo "::endgroup::"
    
    - name: Create test project
      id: project
      if: inputs.create-test-project == 'true'
      shell: bash
      run: |
        echo "::group::üìÅ Creating Test Project"
        
        WORKING_DIR="${{ inputs.working-directory }}"
        
        # Remove existing if it exists
        if [[ -d "$WORKING_DIR" ]]; then
          rm -rf "$WORKING_DIR"
        fi
        
        mkdir -p "$WORKING_DIR"
        cd "$WORKING_DIR"
        
        # Create comprehensive package.json
        cat > package.json << 'EOF'
        {
          "name": "comprehensive-test-project",
          "version": "1.0.0",
          "type": "module",
          "scripts": {
            "dev": "echo 'Starting dev server...' && sleep 1",
            "build": "echo 'Building project...' && mkdir -p dist && echo 'export default {};' > dist/index.js",
            "build:dev": "echo 'Building for development...' && mkdir -p dist && echo 'export default {};' > dist/index.js",
            "lint": "echo 'Running lint...' && exit 0",
            "type-check": "echo 'Running type check...' && exit 0", 
            "test": "echo 'Running tests...' && exit 0",
            "test:coverage": "echo 'Running tests with coverage...' && mkdir -p coverage && echo '{\"total\":{\"lines\":{\"pct\":85}}}' > coverage/coverage-summary.json"
          },
          "devDependencies": {}
        }
        EOF
        
        # Create pnpm-lock.yaml
        cat > pnpm-lock.yaml << 'EOF'
        lockfileVersion: '9.0'
        settings:
          autoInstallPeers: true
          excludeLinksFromLockfile: false
        dependencies: {}
        devDependencies: {}
        EOF
        
        # Create tsconfig.json
        cat > tsconfig.json << 'EOF'
        {
          "compilerOptions": {
            "strict": true,
            "target": "ES2022",
            "module": "ESNext",
            "moduleResolution": "node",
            "esModuleInterop": true,
            "skipLibCheck": true,
            "forceConsistentCasingInFileNames": true
          }
        }
        EOF
        
        # Create eslint.config.mjs
        cat > eslint.config.mjs << 'EOF'
        export default {
          rules: {
            'no-console': 'warn'
          }
        };
        EOF
        
        echo "‚úÖ Test project created in $WORKING_DIR"
        echo "::endgroup::"
    
    - name: Validate action dependencies
      id: validate-deps
      if: inputs.validate-dependencies == 'true' && inputs.test-mode == 'atomic-action'
      shell: bash
      run: |
        echo "::group::üîç Validating Action Dependencies"
        
        TARGET_PATH="${{ inputs.target-path }}"
        
        if [[ -z "$TARGET_PATH" ]]; then
          echo "‚ö†Ô∏è No target path provided, skipping dependency validation"
          echo "::endgroup::"
          exit 0
        fi
        
        ACTION_FILE="$TARGET_PATH/action.yml"
        
        if [[ ! -f "$ACTION_FILE" ]]; then
          echo "‚ùå Action file not found: $ACTION_FILE"
          exit 1
        fi
        
        echo "‚Ä¢ Checking action file: $ACTION_FILE"
        
        # Basic structure check with grep
        echo "‚Ä¢ Checking required fields..."
        
        if grep -q "^name:" "$ACTION_FILE"; then
          echo "‚úÖ Found 'name' field"
        else
          echo "‚ùå Missing 'name' field"
          exit 1
        fi
        
        if grep -q "^description:" "$ACTION_FILE"; then
          echo "‚úÖ Found 'description' field"
        else
          echo "‚ùå Missing 'description' field"
          exit 1
        fi
        
        if grep -q "^runs:" "$ACTION_FILE"; then
          echo "‚úÖ Found 'runs' field"
        else
          echo "‚ùå Missing 'runs' field"
          exit 1
        fi
        
        echo "‚úÖ Action structure is valid"
        
        echo "::endgroup::"
    
    - name: Validate references  
      id: validate-refs
      if: inputs.enable-reference-validation == 'true' && inputs.target-path != ''
      uses: ./actions/utilities/reference-validator
      with:
        target-file: ${{ inputs.test-mode == 'pack-workflow' && inputs.target-path || format('{0}/action.yml', inputs.target-path) }}
        available-actions: ${{ inputs.available-actions }}
        file-type: ${{ inputs.test-mode == 'pack-workflow' && 'workflow' || 'action' }}
    
    - name: Run comprehensive test
      id: run-test
      shell: bash
      run: |
        echo "::group::üß™ Running Comprehensive Test"
        
        TEST_MODE="${{ inputs.test-mode }}"
        TARGET_PATH="${{ inputs.target-path }}"
        WORKING_DIR="${{ inputs.working-directory }}"
        TEST_NAME="${{ inputs.test-name }}"
        
        START_TIME=$(date +%s)
        TEST_RESULT="success"
        TEST_DETAILS=""
        
        case "$TEST_MODE" in
          atomic-action)
            echo "üî¨ Testing Atomic Action: $TEST_NAME"
            
            if [[ -z "$TARGET_PATH" ]]; then
              echo "‚ùå Target path required for atomic action testing"
              TEST_RESULT="failure"
              TEST_DETAILS="Missing target path"
            else
              # Test that action path exists
              if [[ -f "$TARGET_PATH/action.yml" ]]; then
                echo "‚úÖ Action file exists: $TARGET_PATH/action.yml"
                
                # Check if it's in correct domain structure
                if [[ "$TARGET_PATH" =~ ^actions/[^/]+/[^/]+$ ]]; then
                  echo "‚úÖ Uses domain-organized structure"
                elif [[ "$TARGET_PATH" =~ ^actions/(test|health-check)$ ]]; then
                  echo "‚úÖ Global action (allowed at root level)"
                else
                  echo "‚ö†Ô∏è Warning: Action not in expected domain structure"
                fi
                
                TEST_DETAILS="Action validated successfully"
              else
                echo "‚ùå Action file not found: $TARGET_PATH/action.yml"
                TEST_RESULT="failure"
                TEST_DETAILS="Action file not found"
              fi
            fi
            ;;
            
          pack-workflow)
            echo "üì¶ Testing Pack Workflow: $TEST_NAME"
            
            if [[ -z "$TARGET_PATH" ]]; then
              echo "‚ùå Target path required for pack workflow testing"
              TEST_RESULT="failure"
              TEST_DETAILS="Missing target path"
            else
              # Test that workflow file exists and is valid YAML
              if [[ -f "$TARGET_PATH" ]]; then
                echo "‚úÖ Workflow file exists: $TARGET_PATH"
                
                # Check for workflow_call trigger
                echo "‚Ä¢ Checking workflow triggers..."
                
                if grep -q "workflow_call:" "$TARGET_PATH"; then
                  echo "‚úÖ Has workflow_call trigger"
                  TEST_DETAILS="Workflow validated successfully"
                else
                  echo "‚ö†Ô∏è No workflow_call trigger found"
                  TEST_DETAILS="Workflow validated (no workflow_call trigger)"
                fi
                
              else
                echo "‚ùå Workflow file not found: $TARGET_PATH"
                TEST_RESULT="failure"
                TEST_DETAILS="Workflow file not found"
              fi
            fi
            ;;
            
          integration)
            echo "üîó Running Integration Test: $TEST_NAME"
            
            # Test full workflow sequence if test project exists
            if [[ "${{ inputs.create-test-project }}" == "true" && -d "$WORKING_DIR" ]]; then
              cd "$WORKING_DIR"
              
              echo "‚Ä¢ Testing build process..."
              if pnpm run build 2>/dev/null || npm run build 2>/dev/null; then
                echo "‚úÖ Build successful"
              else
                echo "‚ùå Build failed"
                TEST_RESULT="failure"
                TEST_DETAILS="Build process failed"
              fi
              
              echo "‚Ä¢ Testing lint process..."
              if pnpm run lint 2>/dev/null || npm run lint 2>/dev/null; then
                echo "‚úÖ Lint successful"
              else
                echo "‚ö†Ô∏è Lint warning (non-critical)"
              fi
              
              # Check build output
              if [[ -f "dist/index.js" ]]; then
                echo "‚úÖ Build output verified"
                TEST_DETAILS="Integration test completed successfully"
              else
                echo "‚ùå Build output not found"
                TEST_RESULT="failure"
                TEST_DETAILS="Build output verification failed"
              fi
            else
              echo "‚úÖ Integration test completed (no test project)"
              TEST_DETAILS="Integration test completed"
            fi
            ;;
        esac
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "‚Ä¢ Test duration: ${DURATION}s"
        echo "‚Ä¢ Test result: $TEST_RESULT"
        echo "‚Ä¢ Test details: $TEST_DETAILS"
        
        echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
        echo "details=$TEST_DETAILS" >> $GITHUB_OUTPUT
        
        if [[ "$TEST_RESULT" == "failure" ]]; then
          echo "‚ùå Test failed: $TEST_DETAILS"
          echo "::endgroup::"
          exit 1
        else
          echo "‚úÖ Test passed: $TEST_DETAILS"
        fi
        
        echo "::endgroup::"