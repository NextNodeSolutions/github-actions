name: DNS Cloudflare

# EXTERNAL WORKFLOW - Atomic Cloudflare DNS update workflow
# Configures DNS records via Cloudflare API

on:
  workflow_call:
    inputs:
      domain:
        description: 'Domain to configure'
        required: true
        type: string
      target:
        description: 'Target URL or IP address'
        required: true
        type: string
      record-type:
        description: 'DNS record type (A, AAAA, CNAME)'
        required: false
        default: 'CNAME'
        type: string
      proxied:
        description: 'Enable Cloudflare proxy'
        required: false
        default: true
        type: boolean
      ttl:
        description: 'DNS TTL in seconds (1 = automatic)'
        required: false
        default: '1'
        type: string
      enable-seo-setup:
        description: 'Enable automatic SEO configuration'
        required: false
        default: true
        type: boolean
      blocked-subdomains:
        description: 'Comma-separated list of subdomains to block from search engines'
        required: false
        default: 'dev,staging,test,preview'
        type: string
      allowed-subdomains:
        description: 'Comma-separated list of subdomains to ALWAYS allow (whitelist, overrides blocked list)'
        required: false
        default: ''
        type: string
      enable-optimizations:
        description: 'Enable Cloudflare performance optimizations'
        required: false
        default: true
        type: boolean
      enable-health-check:
        description: 'Enable health check after DNS configuration'
        required: false
        default: true
        type: boolean
      health-check-mandatory:
        description: 'Make health check mandatory (workflow fails if health check fails)'
        required: false
        default: false
        type: boolean
      health-check-max-attempts:
        description: 'Max health check attempts'
        required: false
        default: '4'
        type: string
      health-check-delay:
        description: 'Delay between health check attempts (seconds)'
        required: false
        default: '30'
        type: string
      dns-propagation-wait:
        description: 'Wait time for DNS propagation (seconds)'
        required: false
        default: '60'
        type: string
      enable-ssl-setup:
        description: 'Enable automatic SSL/TLS mode configuration (recommended for Railway)'
        required: false
        default: true
        type: boolean
      ssl-mode:
        description: 'SSL/TLS mode: off, flexible, full, strict (Railway requires "full")'
        required: false
        default: 'full'
        type: string
    outputs:
      dns-updated:
        description: 'Whether DNS was successfully updated'
        value: ${{ jobs.update.outputs.success }}
      record-id:
        description: 'Cloudflare DNS record ID'
        value: ${{ jobs.update.outputs.record-id }}
      ssl-configured:
        description: 'Whether SSL/TLS was successfully configured'
        value: ${{ jobs.ssl-setup.outputs.ssl-configured }}
      ssl-mode:
        description: 'SSL/TLS mode configured'
        value: ${{ jobs.ssl-setup.outputs.ssl-mode }}
      seo-configured:
        description: 'Whether SEO configuration was successful'
        value: ${{ jobs.seo-setup.outputs.seo-configured }}
      transform-rules-created:
        description: 'Number of transform rules created for SEO'
        value: ${{ jobs.seo-setup.outputs.transform-rules-created }}

jobs:
  validate-tokens:
    name: Validate Tokens
    runs-on: ubuntu-latest
    steps:
      - uses: NextNodeSolutions/github-actions/actions/utilities/validate-tokens@main
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          fail-on-invalid: true

  ssl-setup:
    name: Configure SSL/TLS
    needs: [validate-tokens]
    if: ${{ inputs.enable-ssl-setup == true }}
    runs-on: ubuntu-latest
    outputs:
      ssl-configured: ${{ steps.ssl.outputs.ssl-configured }}
      ssl-mode: ${{ steps.ssl.outputs.new-mode }}
      zone-id: ${{ steps.ssl.outputs.zone-id }}
    steps:
      # SECURITY: Checkouts internal NextNode repo using the calling workflow's token.
      # This is safe because github-actions is owned by the same organization.
      - name: Checkout Actions Repository
        uses: actions/checkout@v4
        with:
          repository: NextNodeSolutions/github-actions
          token: ${{ github.token }}
          path: .github-actions

      - name: Configure Cloudflare SSL/TLS
        id: ssl
        uses: ./.github-actions/actions/ssl/cloudflare-ssl-setup
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          domain: ${{ inputs.domain }}
          ssl-mode: ${{ inputs.ssl-mode }}

  update:
    name: Update DNS
    runs-on: ubuntu-latest
    needs: [validate-tokens, ssl-setup]
    if: |
      always() &&
      needs.validate-tokens.result == 'success' &&
      (needs.ssl-setup.result == 'success' || needs.ssl-setup.result == 'skipped')
    outputs:
      success: ${{ steps.dns-upsert.outputs.success == 'true' }}
      record-id: ${{ steps.dns-upsert.outputs.record-id }}
    steps:
      - name: Checkout Actions Repository
        uses: actions/checkout@v4
        with:
          repository: NextNodeSolutions/github-actions
          token: ${{ github.token }}
          path: .github-actions

      # Step 1: Zone Lookup (reusable)
      - name: Lookup Cloudflare Zone
        id: zone-lookup
        uses: ./.github-actions/actions/utilities/cloudflare-zone-lookup
        with:
          domain: ${{ inputs.domain }}
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # Step 2: Main DNS Record Upsert (includes sub-subdomain detection, CNAME cleaning)
      - name: Upsert Main DNS Record
        id: dns-upsert
        uses: ./.github-actions/actions/infrastructure/cloudflare-dns-upsert
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID || steps.zone-lookup.outputs.zone-id }}
          domain: ${{ inputs.domain }}
          record-type: ${{ inputs.record-type }}
          content: ${{ inputs.target }}
          proxied: ${{ inputs.proxied }}
          ttl: ${{ inputs.ttl }}

      # Step 3: Create Wildcard DNS for sub-subdomains (conditional)
      - name: Create Wildcard DNS (for sub-subdomains)
        id: wildcard
        if: steps.zone-lookup.outputs.is-sub-subdomain == 'true'
        uses: ./.github-actions/actions/infrastructure/cloudflare-wildcard-create
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID || steps.zone-lookup.outputs.zone-id }}
          parent-domain: ${{ steps.zone-lookup.outputs.parent-subdomain }}
          target: ${{ steps.dns-upsert.outputs.resolved-content }}
          record-type: ${{ inputs.record-type }}
          proxied: ${{ steps.dns-upsert.outputs.effective-proxied }}
          ttl: ${{ inputs.ttl }}

      # Step 4: Create ACME Challenge Record for Railway SSL (conditional)
      - name: Create ACME Challenge Record (for Railway SSL)
        id: acme
        if: inputs.record-type == 'CNAME' && steps.dns-upsert.outputs.effective-proxied == 'false'
        uses: ./.github-actions/actions/infrastructure/cloudflare-acme-record-create
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID || steps.zone-lookup.outputs.zone-id }}
          domain: ${{ inputs.domain }}
          target: ${{ steps.dns-upsert.outputs.resolved-content }}
          ttl: '1'

      # Step 5: Create www subdomain (conditional)
      - name: Create www Subdomain
        id: www
        if: ${{ !startsWith(inputs.domain, 'www.') }}
        uses: ./.github-actions/actions/infrastructure/cloudflare-dns-upsert
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID || steps.zone-lookup.outputs.zone-id }}
          domain: www.${{ inputs.domain }}
          record-type: CNAME
          content: ${{ steps.dns-upsert.outputs.resolved-content }}
          proxied: 'true'
          ttl: '1'
        continue-on-error: true

  seo-setup:
    name: Configure SEO
    runs-on: ubuntu-latest
    needs: update
    if: ${{ inputs.enable-seo-setup == true && needs.update.outputs.success == 'true' }}
    outputs:
      seo-configured: ${{ steps.seo.outputs.seo-configured }}
      transform-rules-created: ${{ steps.seo.outputs.transform-rules-created }}
    
    steps:
      - name: Checkout Actions Repository
        uses: actions/checkout@v4
        with:
          repository: NextNodeSolutions/github-actions
          token: ${{ github.token }}
          path: .github-actions
          
      - name: üéØ Configure Cloudflare SEO
        id: seo
        uses: ./.github-actions/actions/seo/cloudflare-seo-setup
        with:
          domain: ${{ inputs.domain }}
          blocked-subdomains: ${{ inputs.blocked-subdomains }}
          allowed-subdomains: ${{ inputs.allowed-subdomains }}
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          enable-www-redirect: true
          enable-optimizations: ${{ inputs.enable-optimizations }}
          dry-run: false
          
      - name: üìä Configuration Summary
        run: |
          echo "## üìä Configuration Summary"
          echo ""
          echo "| Component | Status | Details |"
          echo "|-----------|--------|---------|"
          echo "| üåê DNS Records | ${{ needs.update.outputs.success == 'true' && '‚úÖ Updated' || '‚ùå Failed' }} | ${{ inputs.domain }} |"
          echo "| üéØ SEO Config | ${{ steps.seo.outputs.seo-configured == 'true' && '‚úÖ Configured' || '‚ö†Ô∏è Skipped' }} | Transform Rules + Redirects |"
          echo "| ü§ñ Transform Rules | ${{ steps.seo.outputs.transform-rules-created > '0' && '‚úÖ Active' || '‚ûñ None' }} | ${{ steps.seo.outputs.transform-rules-created }} created |"
          echo "| üîÄ Redirects | ${{ steps.seo.outputs.redirects-count > '0' && '‚úÖ Active' || '‚ûñ None' }} | ${{ steps.seo.outputs.redirects-count || '0' }} created |"
          echo "| ‚ö° Optimizations | ${{ inputs.enable-optimizations == true && '‚úÖ Enabled' || '‚ûñ Disabled' }} | Minify, Brotli, HTTPS |"
          echo "| üè• Health Check | ${{ inputs.enable-health-check == true && '‚úÖ Enabled' || '‚ûñ Disabled' }} | ${{ inputs.health-check-mandatory == true && 'Mandatory' || 'Optional' }} |"
          echo ""
          echo "**Blocked subdomains:** ${{ inputs.blocked-subdomains }}"
          if [[ -n "${{ inputs.allowed-subdomains }}" ]]; then
            echo "**Allowed subdomains (whitelist):** ${{ inputs.allowed-subdomains }}"
          fi

      - name: ‚úÖ SEO Configuration Complete
        if: steps.seo.outputs.seo-configured == 'true'
        run: |
          echo "::notice title=SEO Configuration Complete::All SEO configuration completed automatically via Transform Rules and Single Redirects. No manual steps required."

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [seo-setup]
    if: ${{ inputs.enable-health-check == true }}
    steps:
      - name: Wait for DNS Propagation
        shell: bash
        run: |
          echo "::group::‚è±Ô∏è Waiting for DNS Propagation"
          echo "Waiting ${{ inputs.dns-propagation-wait }} seconds for DNS records to propagate..."
          sleep ${{ inputs.dns-propagation-wait }}
          echo "::endgroup::"

      - name: Check Deployment Health
        uses: NextNodeSolutions/github-actions/actions/health-check@main
        with:
          url: https://${{ inputs.domain }}
          max-attempts: ${{ inputs.health-check-max-attempts }}
          delay-seconds: ${{ inputs.health-check-delay }}
          expected-status: '200'
        continue-on-error: ${{ inputs.health-check-mandatory == false }}
