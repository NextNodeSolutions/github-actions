name: DNS Cloudflare

# EXTERNAL WORKFLOW - Atomic Cloudflare DNS update workflow
# Configures DNS records via Cloudflare API

on:
  workflow_call:
    inputs:
      domain:
        description: 'Domain to configure'
        required: true
        type: string
      target:
        description: 'Target URL or IP address'
        required: true
        type: string
      record-type:
        description: 'DNS record type (A, AAAA, CNAME)'
        required: false
        default: 'CNAME'
        type: string
      proxied:
        description: 'Enable Cloudflare proxy'
        required: false
        default: true
        type: boolean
      ttl:
        description: 'DNS TTL in seconds (1 = automatic)'
        required: false
        default: '1'
        type: string
    secrets:
      CLOUDFLARE_API_TOKEN:
        required: true
      CLOUDFLARE_ZONE_ID:
        required: false
    outputs:
      dns-updated:
        description: 'Whether DNS was successfully updated'
        value: ${{ jobs.update.outputs.success }}
      record-id:
        description: 'Cloudflare DNS record ID'
        value: ${{ jobs.update.outputs.record-id }}

jobs:
  update:
    name: Update DNS
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.cloudflare.outputs.success == 'true' }}
      record-id: ${{ steps.cloudflare.outputs.record-id }}
    steps:
      - name: Update Cloudflare DNS
        id: cloudflare
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          # Get zone ID if not provided
          if [[ -z "$CF_ZONE_ID" ]]; then
            # Extract root domain from full domain
            ROOT_DOMAIN=$(echo "${{ inputs.domain }}" | awk -F. '{print $(NF-1)"."$NF}')
            
            ZONE_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$ROOT_DOMAIN" \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: application/json")
            
            CF_ZONE_ID=$(echo "$ZONE_RESPONSE" | jq -r '.result[0].id')
            
            if [[ -z "$CF_ZONE_ID" || "$CF_ZONE_ID" == "null" ]]; then
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
          
          # Check if record exists
          EXISTING=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records?name=${{ inputs.domain }}&type=${{ inputs.record-type }}" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json")
          
          echo "DEBUG: API Response for existing records:"
          echo "$EXISTING" | jq '.'
          
          RECORD_COUNT=$(echo "$EXISTING" | jq -r '.result | length')
          echo "DEBUG: Found $RECORD_COUNT existing records"
          
          RECORD_ID=$(echo "$EXISTING" | jq -r '.result[0].id // empty')
          CURRENT_CONTENT=$(echo "$EXISTING" | jq -r '.result[0].content // empty')
          CURRENT_PROXIED=$(echo "$EXISTING" | jq -r '.result[0].proxied // empty')
          
          echo "DEBUG: Extracted values:"
          echo "  • RECORD_ID: '$RECORD_ID'"
          echo "  • CURRENT_CONTENT: '$CURRENT_CONTENT'"
          echo "  • CURRENT_PROXIED: '$CURRENT_PROXIED'"
          
          # Clean target URL for CNAME records (remove https:// if present)
          TARGET_VALUE="${{ inputs.target }}"
          if [[ "${{ inputs.record-type }}" == "CNAME" ]]; then
            # Remove protocol and trailing slash if present
            TARGET_VALUE=$(echo "$TARGET_VALUE" | sed 's|^https\?://||g' | sed 's|/$||g')
            echo "Original target: ${{ inputs.target }}"
            echo "Cleaned CNAME target: $TARGET_VALUE"
          fi
          
          # Check if record already has the correct values
          if [[ -n "$RECORD_ID" && "$RECORD_ID" != "null" && "$RECORD_ID" != "" ]]; then
            echo "Existing record found:"
            echo "  • Record ID: $RECORD_ID"
            echo "  • Current content: $CURRENT_CONTENT"
            echo "  • New content: $TARGET_VALUE"
            echo "  • Current proxied: $CURRENT_PROXIED"
            echo "  • New proxied: ${{ inputs.proxied }}"
            
            # Convert boolean values for comparison
            EXPECTED_PROXIED="${{ inputs.proxied }}"
            if [[ "$CURRENT_CONTENT" == "$TARGET_VALUE" && "$CURRENT_PROXIED" == "$EXPECTED_PROXIED" ]]; then
              echo "✅ DNS record already up to date - no changes needed"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "record-id=$RECORD_ID" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "📝 DNS record needs to be updated"
              echo "  Differences:"
              [[ "$CURRENT_CONTENT" != "$TARGET_VALUE" ]] && echo "    - Content: '$CURRENT_CONTENT' → '$TARGET_VALUE'"
              [[ "$CURRENT_PROXIED" != "$EXPECTED_PROXIED" ]] && echo "    - Proxied: '$CURRENT_PROXIED' → '$EXPECTED_PROXIED'"
            fi
          else
            echo "No existing record found - will create new record"
          fi
          
          # Prepare record data
          RECORD_DATA=$(jq -n \
            --arg type "${{ inputs.record-type }}" \
            --arg name "${{ inputs.domain }}" \
            --arg content "$TARGET_VALUE" \
            --argjson proxied "${{ inputs.proxied }}" \
            --argjson ttl "${{ inputs.ttl }}" \
            '{type: $type, name: $name, content: $content, proxied: $proxied, ttl: $ttl}')
          
          # Create or update record
          if [[ -n "$RECORD_ID" && "$RECORD_ID" != "null" ]]; then
            RESPONSE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records/$RECORD_ID" \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data "$RECORD_DATA")
          else
            RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data "$RECORD_DATA")
            RECORD_ID=$(echo "$RESPONSE" | jq -r '.result.id')
          fi
          
          # Check success
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "record-id=$RECORD_ID" >> $GITHUB_OUTPUT
          
          if [[ "$SUCCESS" != "true" ]]; then
            echo "$RESPONSE" | jq '.errors'
            exit 1
          fi