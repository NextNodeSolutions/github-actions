name: Railway PR Preview Cleanup

# EXTERNAL WORKFLOW - Cleanup PR preview deployments when PR is closed
# Removes the Railway service and custom domain

on:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name for Railway project'
        required: true
        type: string
    secrets:
      RAILWAY_API_TOKEN:
        required: true

jobs:
  cleanup-preview:
    name: Cleanup PR Preview
    runs-on: ubuntu-latest
    # Continue even if cleanup fails - don't block PR closure
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup PR Preview Service
        id: cleanup
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-pr-cleanup@main
        with:
          app-name: ${{ inputs.app-name }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
          pr-number: ${{ github.event.pull_request.number }}

      - name: Comment PR with Cleanup Status
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cleaned = '${{ steps.cleanup.outputs.cleaned }}';
            const serviceName = '${{ steps.cleanup.outputs.service-name }}';
            const prNumber = ${{ github.event.pull_request.number }};

            let comment;
            if (cleaned === 'true') {
              comment = `## ðŸ§¹ PR Preview Cleanup Complete

              âœ… **Service Removed:** \`${serviceName}\`
              ðŸŒ **Environment:** development
              â±ï¸ **Cleaned at:** ${new Date().toISOString()}

              ---
              The preview deployment has been successfully removed from Railway.
              `;
            } else {
              comment = `## âš ï¸ PR Preview Cleanup Notification

              **Service:** \`${serviceName}\`
              **Status:** Could not cleanup or already cleaned

              ---
              The preview deployment may have already been removed or never existed.
              If you see orphaned resources, please check Railway manually.
              `;
            }

            // Find and update existing preview comment or create new cleanup comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸš€ PR Preview Deployment')
            );

            if (botComment) {
              // Update existing preview comment with cleanup status
              const updatedBody = botComment.body + '\n\n' + comment;
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: updatedBody,
              });
            } else {
              // Create new cleanup comment if preview comment not found
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment,
              });
            }
