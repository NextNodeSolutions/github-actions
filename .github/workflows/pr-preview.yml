name: Railway PR Preview

# EXTERNAL WORKFLOW - Automated PR preview deployments to Railway
# Deploys each PR to pr-{number}.dev.{base-domain}
# Uses Railway GraphQL API via atomic workflows

on:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name for Railway project'
        required: true
        type: string
      base-domain:
        description: 'Base domain for PR previews (e.g. nextnode.fr)'
        required: true
        type: string
      base-environment:
        description: 'Base Railway environment for PR previews'
        required: false
        default: 'development'
        type: string
      run-quality-checks:
        description: 'Run quality checks (lint + typecheck) before deployment'
        required: false
        default: true
        type: boolean
      working-directory:
        description: 'Working directory'
        required: false
        default: '.'
        type: string
      memory-mb:
        description: 'Memory allocation in MB for PR preview'
        required: false
        default: '512'
        type: string
      timeout-seconds:
        description: 'Deployment timeout in seconds'
        required: false
        default: '300'
        type: string
    secrets:
      RAILWAY_API_TOKEN:
        required: true
    outputs:
      deployment-url:
        description: 'PR preview deployment URL (https://pr-X.dev.domain)'
        value: ${{ jobs.deploy-preview.outputs.deployment-url }}
      custom-domain:
        description: 'Custom domain for PR preview (pr-X.dev.domain)'
        value: ${{ jobs.deploy-preview.outputs.custom-domain }}
      railway-url:
        description: 'Railway internal URL'
        value: ${{ jobs.deploy-preview.outputs.railway-url }}
      cname-target:
        description: 'CNAME target from Railway for DNS configuration'
        value: ${{ jobs.deploy-preview.outputs.cname-target }}
      service-name:
        description: 'Railway service name'
        value: ${{ jobs.deploy-preview.outputs.service-name }}
      deployment-status:
        description: 'Deployment status (SUCCESS/FAILURE)'
        value: ${{ jobs.deploy-preview.outputs.deployment-status }}

jobs:
  validate-tokens:
    name: Validate Tokens
    runs-on: ubuntu-latest
    steps:
      - uses: NextNodeSolutions/github-actions/actions/utilities/validate-tokens@main
        with:
          railway-api-token: ${{ secrets.RAILWAY_API_TOKEN }}
          fail-on-invalid: true

  quality-checks:
    name: Quality Checks
    needs: [validate-tokens]
    if: inputs.run-quality-checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: NextNodeSolutions/github-actions/actions/node-setup-complete@main
        with:
          working-directory: ${{ inputs.working-directory }}

      - name: Lint
        uses: NextNodeSolutions/github-actions/actions/quality/lint@main
        with:
          working-directory: ${{ inputs.working-directory }}
          fail-on-warning: false

      - name: Type Check
        uses: NextNodeSolutions/github-actions/actions/quality/typecheck@main
        with:
          working-directory: ${{ inputs.working-directory }}

  discover-railway-ids:
    name: Discover Railway IDs
    needs: [validate-tokens, quality-checks]
    if: |
      always() &&
      needs.validate-tokens.result == 'success' &&
      (needs.quality-checks.result == 'success' || needs.quality-checks.result == 'skipped')
    uses: ./.github/workflows/railway-graphql-discover.yml
    with:
      project-name: ${{ inputs.app-name }}
      environment-name: ${{ inputs.base-environment }}
      service-name: pr-${{ github.event.pull_request.number }}_${{ inputs.app-name }}
    secrets:
      railway-token: ${{ secrets.RAILWAY_API_TOKEN }}

  deploy-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    needs: [discover-railway-ids]
    outputs:
      deployment-url: ${{ steps.config.outputs.deployment-url }}
      custom-domain: ${{ steps.config.outputs.custom-domain }}
      service-name: ${{ steps.config.outputs.service-name }}
      railway-url: ${{ steps.config.outputs.railway-url }}
      cname-target: ${{ steps.config.outputs.cname-target }}
      deployment-status: ${{ needs.deploy-service.outputs.deployment-status }}
    steps:
      - name: Calculate Configuration
        id: config
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          APP_NAME="${{ inputs.app-name }}"
          BASE_DOMAIN="${{ inputs.base-domain }}"

          SERVICE_NAME="pr-${PR_NUMBER}_${APP_NAME}"
          CUSTOM_DOMAIN="pr-${PR_NUMBER}.dev.${BASE_DOMAIN}"
          DEPLOYMENT_URL="https://${CUSTOM_DOMAIN}"
          CNAME_TARGET="pr-${PR_NUMBER}.up.railway.app"
          RAILWAY_URL="https://${CNAME_TARGET}"

          echo "service-name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "custom-domain=$CUSTOM_DOMAIN" >> $GITHUB_OUTPUT
          echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "cname-target=$CNAME_TARGET" >> $GITHUB_OUTPUT
          echo "railway-url=$RAILWAY_URL" >> $GITHUB_OUTPUT

          echo "::notice::PR Preview Configuration: $DEPLOYMENT_URL"

  deploy-service:
    name: Deploy to Railway
    needs: [discover-railway-ids, deploy-preview]
    uses: ./.github/workflows/railway-graphql-deploy.yml
    with:
      project-id: ${{ needs.discover-railway-ids.outputs.project-id }}
      environment-id: ${{ needs.discover-railway-ids.outputs.environment-id }}
      service-id: ${{ needs.discover-railway-ids.outputs.service-id }}
      service-name: ${{ needs.deploy-preview.outputs.service-name }}
      repository: ${{ github.repository }}
      branch: ${{ github.head_ref }}
      commit-sha: ${{ github.event.pull_request.head.sha }}
      custom-domain: ${{ needs.deploy-preview.outputs.custom-domain }}
      variables-json: |
        {
          "URL": "${{ needs.deploy-preview.outputs.deployment-url }}",
          "NODE_ENV": "production",
          "HOST": "0.0.0.0",
          "PORT": "3000",
          "RAILWAY_SERVICE_MEMORY_LIMIT_MB": "${{ inputs.memory-mb }}"
        }
      timeout-seconds: ${{ fromJSON(inputs.timeout-seconds) }}
    secrets:
      railway-token: ${{ secrets.RAILWAY_API_TOKEN }}

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [deploy-preview, deploy-service]
    if: always()
    steps:
      - name: Comment PR with Deployment Info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deploymentUrl = '${{ needs.deploy-preview.outputs.deployment-url }}';
            const serviceName = '${{ needs.deploy-preview.outputs.service-name }}';
            const railwayUrl = '${{ needs.deploy-preview.outputs.railway-url }}';
            const status = '${{ needs.deploy-service.outputs.deployment-status }}';
            const prNumber = ${{ github.event.pull_request.number }};
            const runQuality = ${{ inputs.run-quality-checks }};
            const baseEnv = '${{ inputs.base-environment }}';

            // Calculate deployment duration
            const jobStart = new Date('${{ github.event.pull_request.updated_at }}');
            const now = new Date();
            const durationMinutes = Math.floor((now - jobStart) / 1000 / 60);
            const durationSeconds = Math.floor((now - jobStart) / 1000 % 60);
            const durationStr = `${durationMinutes}m ${durationSeconds}s`;

            let qualityChecks = '';
            if (runQuality) {
              qualityChecks = `
            ‚úÖ Lint passed
            ‚úÖ Typecheck passed`;
            }

            const statusEmoji = status === 'SUCCESS' ? '‚úÖ' : '‚ùå';
            const comment = `## üöÄ PR Preview Deployment ${status === 'SUCCESS' ? 'Ready!' : 'Status'}

            ${statusEmoji} **Preview URL:** ${deploymentUrl}
            üîß **Service:** \`${serviceName}\`
            üåç **Environment:** ${baseEnv}
            üìä **Status:** ${status}
            ‚è±Ô∏è **Deployed in:** ${durationStr}${qualityChecks}

            ---
            <details>
            <summary>üîç Railway Details</summary>

            - **Railway URL:** ${railwayUrl}
            - **PR Number:** #${prNumber}
            - **Branch:** \`${{ github.head_ref }}\`
            - **Commit:** \`${{ github.event.pull_request.head.sha }}\`
            - **Memory:** ${{ inputs.memory-mb }}MB
            - **Method:** GraphQL API ‚ú®

            </details>

            > Preview deployments are automatically updated on each commit and cleaned up when the PR is closed.
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üöÄ PR Preview Deployment')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment,
              });
            }
