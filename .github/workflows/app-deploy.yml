name: App Deploy

# EXTERNAL WORKFLOW - Deploy application to Dokploy
# Composes atomic actions for configuration, build, and deployment
# Supports both application and compose deployments

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment: development, preview, production'
        required: true
        type: string
      config-file:
        description: 'Path to project dokploy.toml'
        required: false
        default: 'dokploy.toml'
        type: string
      pr-number:
        description: 'PR number (for preview deployments)'
        required: false
        default: ''
        type: string
      action:
        description: 'Action: deploy or cleanup'
        required: false
        default: 'deploy'
        type: string
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        default: 'Dockerfile'
        type: string
      build-context:
        description: 'Docker build context'
        required: false
        default: '.'
        type: string
      build-args:
        description: 'Docker build arguments (KEY=VALUE format, one per line)'
        required: false
        default: ''
        type: string
      compose-file:
        description: 'Path to docker-compose.yml (skip build if provided)'
        required: false
        default: ''
        type: string
    secrets:
      compose-env:
        description: 'Environment variables for compose deployments (newline-separated KEY=VALUE)'
        required: false
      TAILSCALE_OAUTH_CLIENT_ID:
        description: 'Tailscale OAuth client ID'
        required: true
      TAILSCALE_OAUTH_SECRET:
        description: 'Tailscale OAuth client secret'
        required: true
      DOKPLOY_API_TOKEN:
        description: 'Dokploy API token (from Settings > Profile > API/CLI)'
        required: true
      CLOUDFLARE_API_TOKEN:
        description: 'Cloudflare API token for DNS management'
        required: false
      HETZNER_TOKEN:
        description: 'Hetzner Cloud API token for VPS provisioning'
        required: false
      TF_API_TOKEN:
        description: 'Terraform Cloud API token'
        required: false
      NEXTNODE_APP_ID:
        description: 'GitHub App ID for cross-repo operations'
        required: false
      NEXTNODE_APP_PRIVATE_KEY:
        description: 'GitHub App private key'
        required: false
    outputs:
      project-id:
        description: 'Dokploy project ID'
        value: ${{ jobs.deploy.outputs.project-id }}
      application-id:
        description: 'Dokploy application ID'
        value: ${{ jobs.deploy.outputs.application-id }}
      compose-id:
        description: 'Dokploy compose ID'
        value: ${{ jobs.deploy.outputs.compose-id }}
      domain:
        description: 'Deployed domain'
        value: ${{ jobs.deploy.outputs.domain }}
      success:
        description: 'Whether deployment succeeded'
        value: ${{ jobs.deploy.outputs.success }}
      docker-image:
        description: 'Docker image that was built'
        value: ${{ jobs.build.outputs.image }}

jobs:
  # ==========================================================================
  # CONFIGURATION
  # ==========================================================================
  config:
    name: Load Configuration
    runs-on: ubuntu-latest
    outputs:
      project-name: ${{ steps.config.outputs.project-name }}
      domain: ${{ steps.config.outputs.domain }}
      url: ${{ steps.config.outputs.url }}
      app-name: ${{ steps.config.outputs.app-name }}
      server: ${{ steps.config.outputs.server }}
      port: ${{ steps.config.outputs.port }}
      is-compose: ${{ steps.config.outputs.is-compose }}
      compose-file: ${{ steps.config.outputs.compose-file }}
      traefik-server: ${{ steps.config.outputs.traefik-server }}
      environment-enabled: ${{ steps.config.outputs.environment-enabled }}
      vps-enabled: ${{ steps.config.outputs.vps-enabled }}
      vps-name: ${{ steps.config.outputs.vps-name }}
      vps-type: ${{ steps.config.outputs.vps-type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout Shared Actions
        uses: actions/checkout@v4
        with:
          repository: nextnodesolutions/github-actions
          path: .github-actions

      - name: Load Configuration
        id: config
        uses: ./.github-actions/actions/app/config-load
        with:
          config-file: ${{ inputs.config-file }}
          defaults-file: .github-actions/config/dokploy-defaults.toml
          environment: ${{ inputs.environment }}
          pr-number: ${{ inputs.pr-number }}

  # ==========================================================================
  # BUILD (skip for compose or cleanup)
  # ==========================================================================
  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: [config]
    if: |
      inputs.action == 'deploy' &&
      needs.config.outputs.environment-enabled == 'true' &&
      needs.config.outputs.is-compose == 'false' &&
      inputs.compose-file == ''
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout Shared Actions
        uses: actions/checkout@v4
        with:
          repository: nextnodesolutions/github-actions
          path: .github-actions

      - name: Build and Push to Registry
        id: build
        uses: ./.github-actions/actions/build/docker-build-push
        with:
          tailscale-oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale-oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          dockerfile: ${{ inputs.dockerfile }}
          context: ${{ inputs.build-context }}
          build-args: |
            URL=${{ needs.config.outputs.url }}
            ${{ inputs.build-args }}

  # ==========================================================================
  # VPS PROVISIONING (if needed)
  # ==========================================================================
  provision:
    name: Provision VPS
    runs-on: ubuntu-latest
    needs: [config]
    if: |
      inputs.action == 'deploy' &&
      needs.config.outputs.environment-enabled == 'true' &&
      needs.config.outputs.vps-enabled == 'true' &&
      inputs.environment == 'production'
    steps:
      - name: Checkout Shared Actions
        uses: actions/checkout@v4
        with:
          repository: nextnodesolutions/github-actions
          path: .github-actions

      - name: Get Dokploy URL
        id: dokploy-url
        uses: ./.github-actions/actions/infrastructure/tailscale-dokploy-url
        with:
          tailscale-oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale-oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}

      - name: Get Tailscale Auth Key
        id: tailscale
        uses: ./.github-actions/actions/infrastructure/tailscale-oauth
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          generate-auth-key: 'true'
          auth-key-tags: 'tag:server'
          auth-key-expiry: '3600'

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.NEXTNODE_APP_ID }}
          private-key: ${{ secrets.NEXTNODE_APP_PRIVATE_KEY }}
          owner: nextnodesolutions
          repositories: infrastructure

      - name: Provision Custom VPS
        uses: ./.github-actions/actions/deploy/vps-provision
        with:
          vps-name: ${{ needs.config.outputs.vps-name }}
          project-name: ${{ needs.config.outputs.project-name }}
          server-type: ${{ needs.config.outputs.vps-type }}
          environment: production
          hetzner-token: ${{ secrets.HETZNER_TOKEN }}
          tailscale-auth-key: ${{ steps.tailscale.outputs.auth-key }}
          tailscale-api-token: ${{ steps.tailscale.outputs.api-token }}
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          tf-api-token: ${{ secrets.TF_API_TOKEN }}
          github-token: ${{ steps.app-token.outputs.token }}
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-api-token: ${{ secrets.DOKPLOY_API_TOKEN }}

  # ==========================================================================
  # DEPLOY
  # ==========================================================================
  deploy:
    name: Deploy to Dokploy
    runs-on: ubuntu-latest
    needs: [config, build, provision]
    if: always() && needs.config.outputs.environment-enabled == 'true' && (inputs.action == 'cleanup' || needs.build.result == 'success' || needs.build.result == 'skipped')
    outputs:
      project-id: ${{ steps.project.outputs.project-id }}
      application-id: ${{ steps.app.outputs.application-id }}
      compose-id: ${{ steps.compose.outputs.compose-id }}
      domain: ${{ needs.config.outputs.domain }}
      success: ${{ steps.final.outputs.success }}
    steps:
      - name: Checkout Shared Actions
        uses: actions/checkout@v4
        with:
          repository: nextnodesolutions/github-actions
          path: .github-actions

      - name: Get Dokploy URL
        id: dokploy-url
        uses: ./.github-actions/actions/infrastructure/tailscale-dokploy-url
        with:
          tailscale-oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale-oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}

      - name: Authenticate with Dokploy
        id: auth
        uses: ./.github-actions/actions/app/dokploy-auth
        with:
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-api-token: ${{ secrets.DOKPLOY_API_TOKEN }}

      # ---------- CLEANUP ----------
      - name: Cleanup Preview
        id: cleanup
        if: inputs.action == 'cleanup'
        uses: ./.github-actions/actions/app/dokploy-cleanup
        with:
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-token: ${{ steps.auth.outputs.token }}
          project-name: ${{ needs.config.outputs.project-name }}
          pr-number: ${{ inputs.pr-number }}
          is-compose: ${{ needs.config.outputs.is-compose }}

      # ---------- DEPLOY ----------
      - name: Sync Project
        id: project
        if: inputs.action == 'deploy'
        uses: ./.github-actions/actions/app/dokploy-project-sync
        with:
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-token: ${{ steps.auth.outputs.token }}
          project-name: ${{ needs.config.outputs.project-name }}

      - name: Sync Environment
        id: environment
        if: inputs.action == 'deploy'
        uses: ./.github-actions/actions/app/dokploy-environment-sync
        with:
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-token: ${{ steps.auth.outputs.token }}
          project-id: ${{ steps.project.outputs.project-id }}
          environment: ${{ inputs.environment }}
          pr-number: ${{ inputs.pr-number }}

      - name: Get Tailscale API Token
        id: tailscale
        if: inputs.action == 'deploy'
        uses: ./.github-actions/actions/infrastructure/tailscale-oauth
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}

      - name: Resolve Server
        id: server
        if: inputs.action == 'deploy'
        uses: ./.github-actions/actions/app/server-resolve
        with:
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-token: ${{ steps.auth.outputs.token }}
          server-name: ${{ needs.config.outputs.server }}
          traefik-server: ${{ needs.config.outputs.traefik-server }}
          hcloud-token: ${{ secrets.HETZNER_TOKEN }}
          tailscale-api-token: ${{ steps.tailscale.outputs.api-token }}

      # Deploy application (if not compose)
      - name: Sync Application
        id: app
        if: inputs.action == 'deploy' && needs.config.outputs.is-compose == 'false' && inputs.compose-file == ''
        uses: ./.github-actions/actions/app/dokploy-app-sync
        with:
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-token: ${{ steps.auth.outputs.token }}
          project-id: ${{ steps.project.outputs.project-id }}
          environment-id: ${{ steps.environment.outputs.environment-id }}
          app-name: ${{ needs.config.outputs.app-name }}
          server-id: ${{ steps.server.outputs.server-id }}
          docker-image: ${{ needs.build.outputs.image }}
          domain: ${{ needs.config.outputs.domain }}
          port: ${{ needs.config.outputs.port }}

      # Checkout project repo for compose file (if compose mode)
      - name: Checkout Project
        if: inputs.action == 'deploy' && (needs.config.outputs.is-compose == 'true' || inputs.compose-file != '')
        uses: actions/checkout@v4
        with:
          path: project

      # Deploy compose (if compose mode)
      - name: Sync Compose
        id: compose
        if: inputs.action == 'deploy' && (needs.config.outputs.is-compose == 'true' || inputs.compose-file != '')
        uses: ./.github-actions/actions/app/dokploy-compose-sync
        with:
          dokploy-url: ${{ steps.dokploy-url.outputs.url }}
          dokploy-token: ${{ steps.auth.outputs.token }}
          project-id: ${{ steps.project.outputs.project-id }}
          environment-id: ${{ steps.environment.outputs.environment-id }}
          app-name: ${{ needs.config.outputs.app-name }}
          server-id: ${{ steps.server.outputs.server-id }}
          compose-file: project/${{ inputs.compose-file || needs.config.outputs.compose-file }}
          env: ${{ secrets.compose-env }}

      # DNS Configuration
      - name: Configure DNS
        id: dns
        if: inputs.action == 'deploy' && needs.config.outputs.domain != '' && steps.server.outputs.traefik-public-ip != ''
        uses: ./.github-actions/actions/infrastructure/cloudflare-dns-upsert
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          domain: ${{ needs.config.outputs.domain }}
          content: ${{ steps.server.outputs.traefik-public-ip }}
          proxied: ${{ contains(needs.config.outputs.domain, '.dev.') && 'false' || 'true' }}

      # Cross-Swarm Routing
      - name: Configure Cross-Swarm Routing
        if: |
          inputs.action == 'deploy' &&
          steps.server.outputs.cross-swarm == 'true' &&
          steps.server.outputs.server-tailscale-ip != '' &&
          needs.config.outputs.is-compose == 'false'
        uses: ./.github-actions/actions/deploy/cross-swarm-routing
        with:
          app-name: ${{ needs.config.outputs.app-name }}
          domain: ${{ needs.config.outputs.domain }}
          worker-tailscale-ip: ${{ steps.server.outputs.server-tailscale-ip }}
          admin-tailscale-ip: ${{ steps.dokploy-url.outputs.ip }}
          container-port: ${{ needs.config.outputs.port }}
          use-https: 'true'
          expected-image: ${{ needs.build.outputs.image }}

      - name: Set Final Status
        id: final
        if: always()
        run: |
          if [[ "${{ inputs.action }}" == "cleanup" ]]; then
            echo "success=${{ steps.cleanup.outputs.success || 'true' }}" >> $GITHUB_OUTPUT
          else
            echo "success=${{ steps.app.outputs.success || steps.compose.outputs.success || 'true' }}" >> $GITHUB_OUTPUT
          fi

      - name: Deployment Summary
        if: inputs.action == 'deploy' && steps.final.outputs.success == 'true'
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ needs.config.outputs.domain }}" ]]; then
            echo "| Domain | https://${{ needs.config.outputs.domain }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Project | \`${{ needs.config.outputs.project-name }}\` |" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ needs.build.outputs.image }}" ]]; then
            echo "| Image | \`${{ needs.build.outputs.image }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ steps.server.outputs.cross-swarm }}" == "true" ]]; then
            echo "| Routing | Cross-Swarm via Traefik |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup Summary
        if: inputs.action == 'cleanup'
        run: |
          echo "## Preview Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.cleanup.outputs.deleted }}" == "true" ]]; then
            echo "PR #${{ inputs.pr-number }} preview environment has been cleaned up." >> $GITHUB_STEP_SUMMARY
          else
            echo "No preview environment found for PR #${{ inputs.pr-number }}." >> $GITHUB_STEP_SUMMARY
          fi
