name: Railway Deploy

# EXTERNAL WORKFLOW - Atomic Railway deployment workflow
# Deploys to Railway platform only

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (development/staging/production)'
        required: true
        type: string
      app-name:
        description: 'Application name for Railway project'
        required: true
        type: string
      base-domain:
        description: 'Base domain for custom domain calculation (e.g. nextnode.fr)'
        required: true
        type: string
      working-directory:
        description: 'Working directory'
        required: false
        default: '.'
        type: string
      memory-mb:
        description: 'Memory allocation in MB'
        required: false
        default: '512'
        type: string
      variables:
        description: 'Environment variables as JSON object'
        required: false
        default: '{}'
        type: string
      wait-for-deployment:
        description: 'Wait for deployment to complete'
        required: false
        default: true
        type: boolean
      timeout-seconds:
        description: 'Deployment timeout in seconds'
        required: false
        default: '300'
        type: string
    secrets:
      RAILWAY_API_TOKEN:
        required: true
    outputs:
      deployment-id:
        description: 'Railway deployment ID'
        value: ${{ jobs.deploy.outputs.deployment-id }}
      railway-url:
        description: 'Railway internal URL'
        value: ${{ jobs.deploy.outputs.railway-url }}
      custom-domain:
        description: 'Custom domain calculated from environment and base-domain'
        value: ${{ jobs.deploy.outputs.custom-domain }}
      domain-configured:
        description: 'Whether custom domain was successfully configured on Railway'
        value: ${{ jobs.deploy.outputs.domain-configured }}
      cname-target:
        description: 'CNAME target from Railway for DNS configuration'
        value: ${{ jobs.deploy.outputs.cname-target }}
      deployment-status:
        description: 'Deployment status'
        value: ${{ jobs.deploy.outputs.status }}

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    outputs:
      deployment-id: ${{ steps.wait.outputs.deployment-id }}
      railway-url: ${{ steps.url.outputs.railway-url }}
      custom-domain: ${{ steps.domain.outputs.custom-domain }}
      domain-configured: ${{ steps.railway-domain.outputs.domain-configured }}
      cname-target: ${{ steps.railway-domain.outputs.cname-target }}
      status: ${{ steps.wait.outputs.status }}
      service-name: ${{ steps.service.outputs.service-name }}
      project-id: ${{ steps.project.outputs.project-id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Calculate Custom Domain
        id: domain
        shell: bash
        run: |
          echo "::group::🌐 Calculating Custom Domain"
          
          BASE_DOMAIN="${{ inputs.base-domain }}"
          ENVIRONMENT="${{ inputs.environment }}"
          
          echo "• Base domain: $BASE_DOMAIN"
          echo "• Environment: $ENVIRONMENT"
          
          # Calculate custom domain based on environment
          if [[ "$ENVIRONMENT" == "production" ]]; then
            CUSTOM_DOMAIN="$BASE_DOMAIN"
          elif [[ "$ENVIRONMENT" == "staging" ]]; then
            CUSTOM_DOMAIN="test.$BASE_DOMAIN"
          elif [[ "$ENVIRONMENT" == "development" ]]; then
            CUSTOM_DOMAIN="dev.$BASE_DOMAIN"
          else
            echo "⚠️ Warning: Unknown environment '$ENVIRONMENT'. DNS setup may fail."
            CUSTOM_DOMAIN="unknown.$BASE_DOMAIN"
          fi
          
          echo "• Calculated domain: $CUSTOM_DOMAIN"
          echo "custom-domain=$CUSTOM_DOMAIN" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"
      
      - name: Setup Railway CLI
        id: cli
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-cli-setup@main
        with:
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Setup Project
        id: project
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-project-setup@main
        with:
          app-name: ${{ inputs.app-name }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Setup Service
        id: service
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-service-setup@main
        with:
          app-name: ${{ inputs.app-name }}
          environment: ${{ inputs.environment }}
          project-id: ${{ steps.project.outputs.project-id }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Configure Variables
        id: vars
        if: inputs.variables != '{}'
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-variables@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          environment: ${{ inputs.environment }}
          variables: ${{ inputs.variables }}
          memory-mb: ${{ inputs.memory-mb }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Deploy Application
        id: trigger
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-deploy-trigger@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Wait for Deployment
        id: wait
        if: inputs.wait-for-deployment
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-deployment-wait@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          timeout-seconds: ${{ inputs.timeout-seconds }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Generate URL
        id: url
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-url-generate@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Configure Custom Domain
        id: railway-domain
        if: inputs.base-domain != ''
        uses: NextNodeSolutions/github-actions/actions/domain/railway-domain-setup@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          custom-domain: ${{ steps.domain.outputs.custom-domain }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
          remove-existing: true