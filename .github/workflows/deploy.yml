name: Railway Deploy

# EXTERNAL WORKFLOW - Atomic Railway deployment workflow
# Deploys to Railway platform only

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (development/staging/production)'
        required: true
        type: string
      app-name:
        description: 'Application name for Railway project'
        required: true
        type: string
      base-domain:
        description: 'Base domain for custom domain calculation (e.g. nextnode.fr). Leave empty to skip custom domain setup.'
        required: false
        default: ''
        type: string
      working-directory:
        description: 'Working directory'
        required: false
        default: '.'
        type: string
      memory-mb:
        description: 'Memory allocation in MB'
        required: false
        default: '512'
        type: string
      variables:
        description: 'Environment variables as JSON object'
        required: false
        default: '{}'
        type: string
      wait-for-deployment:
        description: 'Wait for deployment to complete'
        required: false
        default: true
        type: boolean
      timeout-seconds:
        description: 'Deployment timeout in seconds'
        required: false
        default: '300'
        type: string
    secrets:
      RAILWAY_API_TOKEN:
        required: true
    outputs:
      deployment-id:
        description: 'Railway deployment ID'
        value: ${{ jobs.deploy.outputs.deployment-id }}
      railway-url:
        description: 'Railway internal URL'
        value: ${{ jobs.deploy.outputs.railway-url }}
      custom-domain:
        description: 'Custom domain calculated from environment and base-domain'
        value: ${{ jobs.deploy.outputs.custom-domain }}
      domain-configured:
        description: 'Whether custom domain was successfully configured on Railway'
        value: ${{ jobs.deploy.outputs.domain-configured }}
      cname-target:
        description: 'CNAME target from Railway for DNS configuration'
        value: ${{ jobs.deploy.outputs.cname-target }}
      deployment-status:
        description: 'Deployment status'
        value: ${{ jobs.deploy.outputs.status }}

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    outputs:
      deployment-id: ${{ steps.wait.outputs.deployment-id }}
      railway-url: ${{ steps.url.outputs.railway-url }}
      custom-domain: ${{ steps.domain.outputs.custom-domain }}
      domain-configured: ${{ steps.railway-domain.outputs.domain-configured }}
      cname-target: ${{ steps.railway-domain.outputs.cname-target }}
      status: ${{ steps.wait.outputs.status }}
      service-name: ${{ steps.service.outputs.service-name }}
      project-id: ${{ steps.project.outputs.project-id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Calculate Custom Domain
        id: domain
        shell: bash
        run: |
          echo "::group::üåê Calculating Custom Domain"
          
          BASE_DOMAIN="${{ inputs.base-domain }}"
          ENVIRONMENT="${{ inputs.environment }}"
          
          echo "‚Ä¢ Base domain: $BASE_DOMAIN"
          echo "‚Ä¢ Environment: $ENVIRONMENT"
          
          # Calculate custom domain only if base-domain is provided
          if [[ -n "$BASE_DOMAIN" ]]; then
            echo "‚Ä¢ Custom domain configuration enabled"
            
            if [[ "$ENVIRONMENT" == "production" ]]; then
              CUSTOM_DOMAIN="$BASE_DOMAIN"
            elif [[ "$ENVIRONMENT" == "staging" ]]; then
              CUSTOM_DOMAIN="test.$BASE_DOMAIN"
            elif [[ "$ENVIRONMENT" == "development" ]]; then
              CUSTOM_DOMAIN="dev.$BASE_DOMAIN"
            else
              echo "‚ö†Ô∏è Warning: Unknown environment '$ENVIRONMENT'. DNS setup may fail."
              CUSTOM_DOMAIN="unknown.$BASE_DOMAIN"
            fi
            
            echo "‚Ä¢ Calculated domain: $CUSTOM_DOMAIN"
          else
            echo "‚Ä¢ No base domain provided - skipping custom domain setup"
            CUSTOM_DOMAIN=""
            echo "‚Ä¢ Custom domain: (none - will use Railway URLs)"
          fi
          
          echo "custom-domain=$CUSTOM_DOMAIN" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"
      
      - name: Setup Railway CLI
        id: cli
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-cli-setup@main
        with:
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Setup Project
        id: project
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-project-setup@main
        with:
          app-name: ${{ inputs.app-name }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Setup Service
        id: service
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-service-setup@main
        with:
          app-name: ${{ inputs.app-name }}
          environment: ${{ inputs.environment }}
          project-id: ${{ steps.project.outputs.project-id }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Sync Environment Variables
        id: env-sync
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-env-sync@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          environment: ${{ inputs.environment }}
          memory-mb: ${{ inputs.memory-mb }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
          secrets-json: ${{ toJSON(secrets) }}
          vars-json: ${{ toJSON(vars) }}
      
      - name: Configure Additional Variables
        id: vars
        if: inputs.variables != '{}'
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-variables@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          environment: ${{ inputs.environment }}
          variables: ${{ inputs.variables }}
          memory-mb: ${{ inputs.memory-mb }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Deploy Application
        id: trigger
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-deploy-trigger@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Wait for Deployment
        id: wait
        if: inputs.wait-for-deployment
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-deployment-wait@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          timeout-seconds: ${{ inputs.timeout-seconds }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Generate URL
        id: url
        uses: NextNodeSolutions/github-actions/actions/deploy/railway-url-generate@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
      
      - name: Configure Custom Domain
        id: railway-domain
        if: inputs.base-domain != ''
        uses: NextNodeSolutions/github-actions/actions/domain/railway-domain-setup@main
        with:
          service-name: ${{ steps.service.outputs.service-name }}
          custom-domain: ${{ steps.domain.outputs.custom-domain }}
          railway-token: ${{ secrets.RAILWAY_API_TOKEN }}
          remove-existing: true

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: |
      always() &&
      inputs.base-domain != '' &&
      needs.deploy.outputs.deployment-status == 'SUCCESS'
    steps:
      - name: Wait for DNS Propagation
        shell: bash
        run: |
          echo "::group::‚è±Ô∏è Waiting for DNS Propagation"
          echo "Waiting 60 seconds for DNS records to propagate..."
          sleep 60
          echo "::endgroup::"

      - name: Check Deployment Health
        uses: NextNodeSolutions/github-actions/actions/health-check@main
        with:
          url: https://${{ needs.deploy.outputs.custom-domain }}
          max-attempts: 10
          retry-delay: 30
          expected-status: '200'
        continue-on-error: true
