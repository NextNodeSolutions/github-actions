name: Publish Release

# UNIFIED WORKFLOW - Can be called externally OR triggered by repository_dispatch
# Supports both workflow_call for external use AND repository_dispatch for event-driven releases

on:
  workflow_call:
    inputs:
      publish-script:
        description: 'Script for publishing (changeset:publish)'
        required: false
        default: 'changeset:publish'
        type: string
      build-script:
        description: 'Build script to run before publishing'
        required: false
        default: 'build'
        type: string
      enable-provenance:
        description: 'Enable NPM provenance attestation'
        required: false
        default: true
        type: boolean
      dry-run:
        description: 'Run publish in dry-run mode'
        required: false
        default: false
        type: boolean
      create-github-release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean
      # Event data (for workflow_call usage)
      version:
        description: 'Version to publish (required for workflow_call)'
        required: false
        type: string
      pr-number:
        description: 'PR number (required for workflow_call)'
        required: false
        type: string
      merge-commit-sha:
        description: 'Merge commit SHA (required for workflow_call)'
        required: false
        type: string
        
    outputs:
      published:
        description: 'Whether packages were published'
        value: ${{ jobs.publish.outputs.published }}
      version:
        description: 'Published package version'
        value: ${{ jobs.validate-event.outputs.version }}
      tag-name:
        description: 'Created git tag name'
        value: ${{ jobs.tag.outputs.tag-name }}

  repository_dispatch:
    types: [version-merged]
    
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode'
        required: false
        default: false
        type: boolean

concurrency:
  group: publish-${{ github.event.client_payload.data.version || inputs.version || 'auto' }}
  cancel-in-progress: false

# Note: This workflow expects to receive event data via github.event.client_payload.data

jobs:
  validate-tokens:
    name: Validate Tokens
    runs-on: ubuntu-latest
    steps:
      - uses: NextNodeSolutions/github-actions/actions/utilities/validate-tokens@main
        with:
          npm-token: ${{ secrets.NPM_TOKEN }}
          fail-on-invalid: true

  validate-event:
    name: Validate Event Data
    needs: [validate-tokens]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      pr-number: ${{ steps.validate.outputs.pr-number }}
      merge-commit-sha: ${{ steps.validate.outputs.merge-commit-sha }}
      publish-script: ${{ steps.validate.outputs.publish-script }}
      build-script: ${{ steps.validate.outputs.build-script }}
      enable-provenance: ${{ steps.validate.outputs.enable-provenance }}
      dry-run: ${{ steps.validate.outputs.dry-run }}
      create-github-release: ${{ steps.validate.outputs.create-github-release }}
      
    steps:
      - name: Checkout Repository
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
          
      - name: Validate Event Data
        id: validate
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Extract data from repository_dispatch, workflow_call, or workflow_dispatch
          echo "üîç Event details:"
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "üîÑ Processing repository_dispatch event"
            VERSION="${{ github.event.client_payload.data.version }}"
            PR_NUMBER="${{ github.event.client_payload.data.pr_number }}"
            MERGE_SHA="${{ github.event.client_payload.data.merge_commit_sha }}"
            
            # Configuration from event or defaults
            PUBLISH_SCRIPT="${{ github.event.client_payload.data.publish_script || 'changeset:publish' }}"
            BUILD_SCRIPT="${{ github.event.client_payload.data.build_script || 'build' }}"
            ENABLE_PROVENANCE="${{ github.event.client_payload.data.enable_provenance || 'true' }}"
            DRY_RUN="${{ github.event.client_payload.data.dry_run || 'false' }}"
            CREATE_GITHUB_RELEASE="${{ github.event.client_payload.data.create_github_release || 'true' }}"
            
            echo "Triggered By: ${{ github.event.client_payload.data.triggered_by }}"
            echo "Source Repo: ${{ github.event.client_payload.data.repository }}"
          elif [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "üìû Processing workflow_call"
            VERSION="${{ inputs.version }}"
            PR_NUMBER="${{ inputs.pr-number }}"
            MERGE_SHA="${{ inputs.merge-commit-sha }}"
            
            # Configuration from inputs
            PUBLISH_SCRIPT="${{ inputs.publish-script }}"
            BUILD_SCRIPT="${{ inputs.build-script }}"
            ENABLE_PROVENANCE="${{ inputs.enable-provenance }}"
            DRY_RUN="${{ inputs.dry-run }}"
            CREATE_GITHUB_RELEASE="${{ inputs.create-github-release }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üîÑ Processing workflow_dispatch - Auto-detecting release data"
            
            # Ensure we're on main branch for data extraction
            git checkout main 2>/dev/null || {
              echo "‚ö†Ô∏è Not on main branch, staying on current branch"
            }
            
            # Auto-detect version from package.json
            if [ ! -f "package.json" ]; then
              echo "‚ùå No package.json found - cannot auto-detect version"
              exit 1
            fi
            
            VERSION=$(node -p "require('./package.json').version")
            echo "üì¶ Auto-detected version: $VERSION"
            
            # Find the corresponding changeset PR
            echo "üîç Looking for PR with title: v$VERSION"
            PR_DATA=$(gh pr list --repo ${{ github.repository }} --state merged --limit 20 --json number,title,mergeCommit --jq "[.[] | select(.title == \"v$VERSION\")] | first")
            
            if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "null" ]; then
              echo "‚ùå No merged PR found with title 'v$VERSION'"
              echo "Available recent PRs:"
              gh pr list --repo ${{ github.repository }} --state merged --limit 10 --json number,title --jq '.[] | "  #\(.number): \(.title)"'
              exit 1
            fi
            
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
            MERGE_SHA=$(echo "$PR_DATA" | jq -r '.mergeCommit.oid')
            
            echo "‚úÖ Found changeset PR: #$PR_NUMBER"
            echo "‚úÖ Merge commit: $MERGE_SHA"
            
            # Configuration from inputs with their defaults
            PUBLISH_SCRIPT="${{ inputs.publish-script }}"
            BUILD_SCRIPT="${{ inputs.build-script }}"
            ENABLE_PROVENANCE="${{ inputs.enable-provenance }}"
            DRY_RUN="${{ inputs.dry-run }}"
            CREATE_GITHUB_RELEASE="${{ inputs.create-github-release }}"
          else
            echo "‚ùå Unsupported event type: ${{ github.event_name }}"
            echo "This workflow supports:"
            echo "  - repository_dispatch (with 'version-merged' type)"
            echo "  - workflow_call (for external project use)"
            echo "  - workflow_dispatch (manual trigger with auto-detection)"
            echo ""
            echo "Received event: ${{ github.event_name }}"
            exit 1
          fi
          
          # Validate required fields with detailed diagnostics
          if [ -z "$VERSION" ] || [ -z "$PR_NUMBER" ] || [ -z "$MERGE_SHA" ]; then
            echo "‚ùå Missing required data"
            echo "Event Type: ${{ github.event_name }}"
            echo "Version: '$VERSION'"
            echo "PR Number: '$PR_NUMBER'"
            echo "Merge SHA: '$MERGE_SHA'"
            
            if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
              echo ""
              echo "üîç Debugging repository_dispatch payload:"
              echo "Raw client_payload: ${{ toJson(github.event.client_payload) }}"
              echo "Expected data structure: github.event.client_payload.data"
              echo ""
              echo "Available client_payload keys:"
              echo '${{ toJson(github.event.client_payload) }}' | jq -r 'keys[]' 2>/dev/null || echo "Failed to parse client_payload"
              
              if [ -n "${{ github.event.client_payload.data }}" ]; then
                echo ""
                echo "Available data keys:"
                echo '${{ toJson(github.event.client_payload.data) }}' | jq -r 'keys[]' 2>/dev/null || echo "Failed to parse data object"
              fi
            fi
            
            exit 1
          fi
          
          echo "‚úÖ Event data validated"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "merge-commit-sha=$MERGE_SHA" >> $GITHUB_OUTPUT
          echo "publish-script=$PUBLISH_SCRIPT" >> $GITHUB_OUTPUT
          echo "build-script=$BUILD_SCRIPT" >> $GITHUB_OUTPUT
          echo "enable-provenance=$ENABLE_PROVENANCE" >> $GITHUB_OUTPUT
          echo "dry-run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "create-github-release=$CREATE_GITHUB_RELEASE" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "üîç Unified Workflow Details:"
          echo "Event Type: ${{ github.event_name }}"
          echo "Version: $VERSION"
          echo "PR Number: $PR_NUMBER" 
          echo "Merge Commit: $MERGE_SHA"

  tag:
    name: Create Git Tag
    needs: [validate-tokens, validate-event]
    runs-on: ubuntu-latest
    outputs:
      tag-name: ${{ steps.tag.outputs.tag-name }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Checkout the exact merge commit
          ref: ${{ needs.validate-event.outputs.merge-commit-sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git for Tagging
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and Push Git Tag
        id: tag
        run: |
          VERSION="${{ needs.validate-event.outputs.version }}"
          TAG_NAME="v$VERSION"
          
          # Check if tag already exists
          if git tag -l | grep -q "^$TAG_NAME$"; then
            echo "‚ö†Ô∏è Tag $TAG_NAME already exists"
            echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create annotated tag with release notes
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME

          Released via automated workflow from PR #${{ needs.validate-event.outputs.pr-number }}
          
          üöÄ Generated with [Claude Code](https://claude.ai/code)"
          
          # Push tag
          git push origin "$TAG_NAME"
          
          echo "‚úÖ Created and pushed tag: $TAG_NAME"
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT

  publish:
    name: Publish to NPM
    needs: [validate-event, tag]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write # Required for npm provenance
    outputs:
      published: ${{ steps.publish.outputs.published }}
      packages: ${{ steps.publish.outputs.packages }}
      version: ${{ needs.validate-event.outputs.version }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Checkout the exact merge commit  
          ref: ${{ needs.validate-event.outputs.merge-commit-sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Release Environment
        uses: NextNodeSolutions/github-actions/actions/release/changesets-setup@main
        with:
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}

      - name: Verify Package Version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          EXPECTED_VERSION="${{ needs.validate-event.outputs.version }}"
          
          if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "‚ùå Version mismatch!"
            echo "Package.json version: $PACKAGE_VERSION"
            echo "Expected version: $EXPECTED_VERSION"
            exit 1
          fi
          
          echo "‚úÖ Version verified: v$PACKAGE_VERSION"

      - name: Build Package
        if: needs.validate-event.outputs.build-script != ''
        run: |
          echo "üì¶ Building package with script: ${{ inputs.build-script }}"
          pnpm run ${{ needs.validate-event.outputs.build-script }}

      - name: Publish to NPM
        id: publish
        uses: NextNodeSolutions/github-actions/actions/release/changesets-publish@main
        with:
          npm-token: ${{ secrets.NPM_TOKEN }}
          publish-script: ${{ needs.validate-event.outputs.publish-script }}
          dry-run: ${{ needs.validate-event.outputs.dry-run }}
          provenance: ${{ needs.validate-event.outputs.enable-provenance }}

      - name: Verify NPM Publication
        if: steps.publish.outputs.published == 'true' && needs.validate-event.outputs.dry-run == 'false'
        run: |
          VERSION="${{ needs.validate-event.outputs.version }}"
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          
          echo "üîç Verifying publication..."
          sleep 10 # Wait for NPM to propagate
          
          PUBLISHED_VERSION=$(npm view "$PACKAGE_NAME" version 2>/dev/null || echo "none")
          
          if [ "$PUBLISHED_VERSION" = "$VERSION" ]; then
            echo "‚úÖ Successfully published: $PACKAGE_NAME@$VERSION"
            echo "üåê View on NPM: https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION"
          else
            echo "‚ö†Ô∏è NPM publication verification inconclusive"
            echo "Expected: $VERSION, Found: $PUBLISHED_VERSION"
            echo "This might be due to NPM propagation delay"
          fi

  github-release:
    name: Create GitHub Release
    needs: [validate-event, tag, publish]
    if: needs.publish.outputs.published == 'true' && needs.validate-event.outputs.create-github-release == 'true'
    runs-on: ubuntu-latest
    outputs:
      release-url: ${{ steps.release.outputs.release-url }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-event.outputs.merge-commit-sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Release Notes
        id: release-notes
        run: |
          VERSION="${{ needs.validate-event.outputs.version }}"
          TAG_NAME="${{ needs.tag.outputs.tag-name }}"
          
          # Extract changelog section for this version
          if [ -f "CHANGELOG.md" ]; then
            # Get the section between ## $VERSION and the next ## or end of file
            RELEASE_NOTES=$(awk "/^## $VERSION/{flag=1; next} /^## [0-9]/{flag=0} flag" CHANGELOG.md | sed '/^$/d')
            
            if [ -n "$RELEASE_NOTES" ]; then
              echo "Found changelog section for v$VERSION"
              # Save to file for GitHub Release
              cat > release-notes.md << EOF
          ## What's Changed

          $RELEASE_NOTES

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0")...$TAG_NAME

          üöÄ Generated with [Claude Code](https://claude.ai/code)
          EOF
            else
              echo "No specific changelog found for v$VERSION, using generic notes"
              cat > release-notes.md << EOF
          ## What's Changed

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes in this release.

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0")...$TAG_NAME

          üöÄ Generated with [Claude Code](https://claude.ai/code)
          EOF
            fi
          else
            echo "No CHANGELOG.md found, using minimal release notes"
            cat > release-notes.md << EOF
          ## Release $TAG_NAME

          This release was automatically generated from PR #${{ needs.validate-event.outputs.pr-number }}.

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0")...$TAG_NAME

          üöÄ Generated with [Claude Code](https://claude.ai/code)
          EOF
          fi

      - name: Create GitHub Release
        id: release
        run: |
          TAG_NAME="${{ needs.tag.outputs.tag-name }}"
          
          gh release create "$TAG_NAME" \
            --title "$TAG_NAME" \
            --notes-file release-notes.md \
            --latest
          
          RELEASE_URL=$(gh release view "$TAG_NAME" --json url --jq '.url')
          
          echo "‚úÖ Created GitHub Release: $TAG_NAME"
          echo "üîó Release URL: $RELEASE_URL"
          echo "release-url=$RELEASE_URL" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ github.token }}

  summary:
    name: Release Summary
    needs: [validate-event, tag, publish, github-release]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Release Summary
        run: |
          VERSION="${{ needs.validate-event.outputs.version }}"
          PUBLISHED="${{ needs.publish.outputs.published }}"
          TAG_NAME="${{ needs.tag.outputs.tag-name }}"
          RELEASE_URL="${{ needs.github-release.outputs.release-url }}"
          
          echo ""
          echo "üéâ Release Summary for v$VERSION"
          echo "================================"
          echo ""
          echo "üì¶ Published: $PUBLISHED"
          echo "üè∑Ô∏è Git Tag: $TAG_NAME"
          echo "üìù PR: #${{ needs.validate-event.outputs.pr-number }}"
          
          if [ "$PUBLISHED" = "true" ]; then
            PACKAGE_NAME=$(node -p "require('./package.json').name" 2>/dev/null || echo "unknown")
            echo "üåê NPM: https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION"
            echo "‚ú® Install: npm install $PACKAGE_NAME@$VERSION"
          fi
          
          if [ -n "$RELEASE_URL" ]; then
            echo "üîó GitHub Release: $RELEASE_URL"
          fi
          
          echo ""
          if [ "$PUBLISHED" = "true" ]; then
            echo "‚úÖ Release completed successfully!"
          else
            echo "‚ö†Ô∏è Release completed with issues - check individual jobs"
          fi
