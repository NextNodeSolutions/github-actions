name: Railway Prod Deploy

on:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name for Railway project'
        required: true
        type: string
      domain:
        description: 'Custom domain (leave empty for Railway URL only)'
        required: false
        default: ''
        type: string
      run-quality-checks:
        description: 'Run quality checks before deployment'
        required: false
        default: true
        type: boolean
      node-version:
        description: 'Node.js version'
        required: false
        default: '22'
        type: string
      pnpm-version:
        description: 'pnpm version'
        required: false
        default: '10.12.4'
        type: string
      working-directory:
        description: 'Working directory'
        required: false
        default: '.'
        type: string
      memory-mb:
        description: 'Memory allocation in MB'
        required: false
        default: '1024'
        type: string
      app-env:
        description: 'Application environment (LOCAL/DEV/PROD)'
        required: false
        default: 'PROD'
        type: string
      variables:
        description: 'Environment variables as JSON object'
        required: false
        default: '{}'
        type: string
      health-check-url:
        description: 'URL for health check'
        required: false
        default: ''
        type: string
      max-wait-minutes:
        description: 'Maximum wait time for deployment in minutes'
        required: false
        default: '15'
        type: string
    secrets:
      RAILWAY_API_TOKEN:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: false
    outputs:
      deployed-url:
        description: 'Deployed application URL'
        value: ${{ jobs.deploy.outputs.final-url }}
      project-id:
        description: 'Railway project ID'
        value: ${{ jobs.deploy.outputs.project-id }}
      service-id:
        description: 'Railway service ID'
        value: ${{ jobs.deploy.outputs.service-id }}

jobs:
  quality-checks:
    name: QA
    if: inputs.run-quality-checks
    uses: ./.github/workflows/pack-quality-checks.yml
    with:
      run-lint: true
      run-typecheck: true
      run-test: true
      run-build: true
      run-security: true
      test-coverage: true
      node-version: ${{ inputs.node-version }}
      pnpm-version: ${{ inputs.pnpm-version }}
      working-directory: ${{ inputs.working-directory }}
      
  deploy:
    name: Railway
    needs: [quality-checks]
    if: always() && (needs.quality-checks.result == 'success' || needs.quality-checks.result == 'skipped')
    uses: ./.github/workflows/job-deploy-railway.yml
    with:
      env: production
      short-env: prod
      app-name: ${{ inputs.app-name }}
      domain: ${{ inputs.domain }}
      memory-mb: ${{ inputs.memory-mb }}
      app-env: ${{ inputs.app-env }}
      variables: ${{ inputs.variables }}
      health-check-url: ${{ inputs.health-check-url }}
      working-directory: ${{ inputs.working-directory }}
    secrets:
      RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      
  summary:
    name: Production Summary
    runs-on: ubuntu-latest
    needs: [quality-checks, deploy]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "### ðŸš€ Railway Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Project Information
          echo "**Project Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ inputs.app-name }} (${{ needs.deploy.outputs.project-id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** prod_${{ inputs.app-name }} (${{ needs.deploy.outputs.service-id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            FINAL_URL="${{ needs.deploy.outputs.final-url }}"
            RAILWAY_URL="${{ needs.deploy.outputs.railway-url }}"
            CUSTOM_URL="${{ needs.deploy.outputs.custom-url }}"
            
            if [[ -n "$FINAL_URL" ]]; then
              echo "âœ… **Deployed to:** $FINAL_URL" >> $GITHUB_STEP_SUMMARY
              
              if [[ -n "$CUSTOM_URL" && -n "$RAILWAY_URL" ]]; then
                echo "ðŸŒ **Railway URL:** $RAILWAY_URL" >> $GITHUB_STEP_SUMMARY
                echo "ðŸ”— **Custom Domain:** $CUSTOM_URL" >> $GITHUB_STEP_SUMMARY
                echo "ðŸ”’ **SSL:** Configured via Cloudflare" >> $GITHUB_STEP_SUMMARY
              elif [[ -n "$RAILWAY_URL" ]]; then
                echo "ðŸŒ **Railway URL:** $RAILWAY_URL" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âœ… **Deployment completed** (URL not available)" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Add production deployment information
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Production Configuration:**" >> $GITHUB_STEP_SUMMARY
            echo "- Memory: ${{ inputs.memory-mb }}MB" >> $GITHUB_STEP_SUMMARY
            echo "- App Environment: ${{ inputs.app-env }}" >> $GITHUB_STEP_SUMMARY
            echo "- Deployment Timeout: ${{ inputs.max-wait-minutes }} minutes" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ inputs.variables }}" != "{}" ]]; then
              echo "- Custom Environment Variables: âœ…" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ -n "${{ inputs.health-check-url }}" ]]; then
              echo "- Health Check: âœ… Custom URL" >> $GITHUB_STEP_SUMMARY
            elif [[ -n "${{ needs.deploy.outputs.railway-url }}" ]]; then
              echo "- Health Check: âœ… Default Railway URL" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Production deployment successful!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Production deployment failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the deployment logs for more information." >> $GITHUB_STEP_SUMMARY
            echo "For production issues, consider:" >> $GITHUB_STEP_SUMMARY
            echo "- Reviewing quality check failures" >> $GITHUB_STEP_SUMMARY
            echo "- Checking Railway service logs" >> $GITHUB_STEP_SUMMARY
            echo "- Verifying environment variables and configuration" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi