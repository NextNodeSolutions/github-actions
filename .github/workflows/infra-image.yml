name: Build Infrastructure Image

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/packer/**'
      - 'infrastructure/config.json'
  workflow_dispatch:
    inputs:
      location:
        description: 'Hetzner datacenter location (leave empty to use config.json)'
        required: false
        type: string

concurrency:
  group: infra-image
  cancel-in-progress: false

jobs:
  build:
    name: Build NixOS + Dokploy Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load Infrastructure Config
        id: config
        run: |
          LOCATION=$(jq -r '.hetzner.location' infrastructure/config.json)
          SERVER_TYPE=$(jq -r '.hetzner.server_types.packer_build' infrastructure/config.json)
          echo "location=${LOCATION}" >> $GITHUB_OUTPUT
          echo "server_type=${SERVER_TYPE}" >> $GITHUB_OUTPUT
          echo "Loaded config: location=${LOCATION}, server_type=${SERVER_TYPE}"

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      - name: Initialize Packer
        working-directory: infrastructure/packer
        run: packer init .

      - name: Validate Packer Configuration
        working-directory: infrastructure/packer
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_TOKEN }}
        run: |
          packer validate \
            -var "hcloud_token=${HCLOUD_TOKEN}" \
            -var "location=${{ inputs.location || steps.config.outputs.location }}" \
            nixos-dokploy.pkr.hcl

      - name: Build Image
        working-directory: infrastructure/packer
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_TOKEN }}
        run: |
          packer build \
            -var "hcloud_token=${HCLOUD_TOKEN}" \
            -var "location=${{ inputs.location || steps.config.outputs.location }}" \
            nixos-dokploy.pkr.hcl
