name: Railway GraphQL - Cleanup Service

# ATOMIC WORKFLOW - Delete Railway service via GraphQL API
# Removes service and all associated resources

on:
  workflow_call:
    inputs:
      project-id:
        description: 'Railway project ID'
        required: true
        type: string
      environment-id:
        description: 'Railway environment ID'
        required: true
        type: string
      service-id:
        description: 'Service ID to delete (optional if service-name provided)'
        required: false
        type: string
        default: ''
      service-name:
        description: 'Service name to lookup and delete (optional if service-id provided)'
        required: false
        type: string
        default: ''
    secrets:
      railway-token:
        required: true
    outputs:
      deleted:
        description: 'Whether service was deleted (true/false)'
        value: ${{ jobs.cleanup.outputs.deleted }}
      service-id:
        description: 'ID of deleted service'
        value: ${{ jobs.cleanup.outputs.service-id }}

jobs:
  cleanup:
    name: Cleanup Service
    runs-on: ubuntu-latest
    # Don't fail PR closure if cleanup fails
    continue-on-error: true
    outputs:
      deleted: ${{ steps.cleanup.outputs.deleted }}
      service-id: ${{ steps.cleanup.outputs.service-id }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cleanup Railway Service
        id: cleanup
        env:
          RAILWAY_TOKEN: ${{ secrets.railway-token }}
          PROJECT_ID: ${{ inputs.project-id }}
          ENVIRONMENT_ID: ${{ inputs.environment-id }}
          SERVICE_ID: ${{ inputs.service-id }}
          SERVICE_NAME: ${{ inputs.service-name }}
        run: |
          echo "::group::ðŸ§¹ Cleaning up Railway Service"

          RAILWAY_API="https://backboard.railway.app/graphql/v2"

          # Determine service ID if only name provided
          if [[ -z "$SERVICE_ID" && -n "$SERVICE_NAME" ]]; then
            echo "ðŸ” Looking up service by name: $SERVICE_NAME"
            SERVICE_RESPONSE=$(curl -s -X POST "$RAILWAY_API" \
              -H "Authorization: Bearer $RAILWAY_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$(jq -n \
                --arg projectId "$PROJECT_ID" \
                --arg environmentId "$ENVIRONMENT_ID" \
                '{
                  query: "query($projectId: String!, $environmentId: String!) { services(projectId: $projectId, environmentId: $environmentId) { edges { node { id name } } } }",
                  variables: { projectId: $projectId, environmentId: $environmentId }
                }')")

            ERRORS=$(echo "$SERVICE_RESPONSE" | jq -r '.errors // empty')
            if [[ -n "$ERRORS" ]]; then
              echo "âš ï¸  Query error: $ERRORS"
              echo "deleted=false" >> $GITHUB_OUTPUT
              echo "service-id=" >> $GITHUB_OUTPUT
              exit 0
            fi

            SERVICE_ID=$(echo "$SERVICE_RESPONSE" | jq -r \
              ".data.services.edges[] | select(.node.name == \"$SERVICE_NAME\") | .node.id")

            if [[ -z "$SERVICE_ID" || "$SERVICE_ID" == "null" ]]; then
              echo "â„¹ï¸  Service '$SERVICE_NAME' not found (already deleted or never existed)"
              echo "deleted=false" >> $GITHUB_OUTPUT
              echo "service-id=" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "âœ… Found service: $SERVICE_ID"
          fi

          if [[ -z "$SERVICE_ID" ]]; then
            echo "âŒ No service ID or name provided"
            echo "deleted=false" >> $GITHUB_OUTPUT
            echo "service-id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Delete the service
          echo "ðŸ—‘ï¸  Deleting service: $SERVICE_ID..."
          DELETE_RESPONSE=$(curl -s -X POST "$RAILWAY_API" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg id "$SERVICE_ID" \
              '{
                query: "mutation($id: String!) { serviceDelete(id: $id) }",
                variables: { id: $id }
              }')")

          ERRORS=$(echo "$DELETE_RESPONSE" | jq -r '.errors // empty')
          if [[ -n "$ERRORS" ]]; then
            echo "âŒ Deletion failed: $ERRORS"
            echo "deleted=false" >> $GITHUB_OUTPUT
            echo "service-id=$SERVICE_ID" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… Service deleted successfully"
          echo "deleted=true" >> $GITHUB_OUTPUT
          echo "service-id=$SERVICE_ID" >> $GITHUB_OUTPUT

          echo "::endgroup::"

          echo "::notice::âœ… Service cleanup complete: $SERVICE_ID"
